<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>vchat.co</title>
	<link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" />
	<script type="text/javascript" src="/js/jquery-1.6.3.min.js"></script> 	
	<script type="text/javascript" src="/js/we.min.js"></script>
	<style type="text/css">
		h1{margin:50px 0;}
		ul{list-style: none;margin:20px 0;}
		ul li{float:left;margin-right: 70px;text-align: center;}
		strong{display: block;}
	</style>
</head>
<body>
	<h1>Socket Test Page</h1>
	<div>
		
		<input type="text" value="f6aec25d971e1a2961e161bf52d39f05" id="roomid"> <input type="button" value="登录到" onclick="loginVchat()" >
		<div>
		<input type="text" value="f6aec25d971e1a2961e161bf52d39f05" id="testmsg">	
		<input type="button" value="testmessage" onclick="testMessage()" >	
	
		</div>	
		
	</div>
	<div>
		<h2>创建用户</h2>
			<form action="/sys/vchat-create" method="post" >
			<input type="text" value="vchat.co" name="domain" >
			<input type="text" name="uid" value="xxoox">
			
			<input type="submit" value="创建vchat.js账户" onclick="createVchatUser()">
		</form>
	</div>
	

	<div>
		<h2>获取 chat server</h2>
			<form action="/sys/vchat-login" method="post" >
			<input type="text" value="vchat.co" name="domain" >
			
			<input type="submit" value="获取 chat server" onclick="createVchatUser()">
		</form>
	</div>

	<script>

		
		var socket = null;

		function loginVchat(){

			var roomid = document.getElementById('roomid').value;
			socket = new WebSocket("ws://"+window.location.host);
			var socketMessage = {
				"connection":function(){
					//登录到房间
					socket.send( JSON.stringify({ type:"login", data:{roomid:roomid} }) );

				},
				"on-line":function( data ){
					console.log("on-line", data);
				},
				"off-line":function( data ){
					console.log("off-line", data);
				},
				"user-list":function( data ){
					console.log("user-list", data);
					//WE.pageChat.userlist.init( data );
				},
				"new-chat":function( data ){
					console.log("new-chat", data);
				}
			};

			socket.onopen = function( e ){};
			
			socket.onmessage = function( e ){
				var data = JSON.parse(e.data);
				//console.log("onmessage", data);
				if( socketMessage[data.type] ){
					socketMessage[data.type]( data.data );
				}else{
					console.log("onmessage miss", data);
				}
			}

			socket.onclose = function(){}

		}

		function testMessage(){
			var msg = document.getElementById('testmsg').value;
			var roomid = document.getElementById('roomid').value;
			new WE.BaseModel().post("/post",{roomid:roomid, text:msg});
		}

	</script>
</body>
</html>