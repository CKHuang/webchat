WE.pageChat={isLoading:0,lastTime:null,init:function(){this.ui={postBox:$("#post-box"),replayBox:$("#replay-box")};this.regEvent()},regEvent:function(){var a=this;this.ui.postBox.find(".text-box input").keyup(function(b){b.keyCode==13&&(b=$.trim($(this).val()),a.post(ROOM.id,b))})},post:function(a,b,c){aim=!c?void 0:c;var d=this,c=new WE.api.ChatModel,f=new WE.Controller;f.update=function(a){a.data.code==0&&d.ui.postBox.find(".text-box input").val("")};c.addObserver(f);c.postChat(a,b,aim)},setReply:function(a){var b=
this;this.ui.replayBox.html(WE.kit.tmpl(this.replyTmpl,a));this.ui.replayBox.removeClass("hidden");this.ui.replayBox.find(".close-btn").click(function(){b.ui.replayBox.empty();b.ui.replayBox.addClass("hidden")})},replyTmpl:'<div class="replay-box">\t\t\t\t\t<div class="arrow"></div>\t\t\t\t\t<span class="icon-close close-btn"></span>\t\t\t\t\t<div>\t\t\t\t\t\t<a href="/user/<%=from._id%>" class="name"><%=from.name%></a>\t\t\t\t\t</div>\t\t\t\t\t<div class="context"><%=text %></div>\t\t\t\t</div>'};
WE.pageChat.timeLine={tmpl:'<div class="talk <% if( from._id == USER._id ){ %> me <% } %>">\t\t\t\t<div class="photo">\t\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" data-uid="<%=from._id%>">\t\t\t\t\t\t<img src="<%=from.avatar%>">\t\t\t\t\t</a>\t\t\t\t</div>\t\t\t\t<div class="info">\t\t\t\t\t<div class="head">\t\t\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" class="name"><%=from.name%></a>\t\t\t\t\t\t<a target="_blank" href="/d/<%=_id%>" class="time">\t\t\t\t\t\t\t<%=WE.kit.format( new Date( time*1000 ),"MM-dd hh:mm:ss" )%>\t\t\t\t\t\t</a>\t\t\t\t\t</div>\t\t\t\t\t<% if(obj.aim){ %>\t\t\t\t\t<div class="reply"><%=aim.text%></div>\t\t\t\t\t<% } %>\t\t\t\t\t<div class="context">\t\t\t\t\t\t<%=WE.markdown.format(text)%><a href="javascript:;" data-mid="<%=_id%>" class="icon-reply chat-reply" title="\u56de\u590d"></a>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t</div>',
mapData:{},init:function(a){for(var b=this,c=0,d=a.length;c<d;c++)this.mapData[a[c]._id]=a[c];this.appends(a);d&&a[d-1].time?WE.pageChat.lastTime=a[d-1].time:(WE.pageChat.isLoading=2,WE.pageChat.lastTime=-1);$("#timeline-talks").delegate(".chat-reply","click",function(){console.log("_this.mapData[id]",b.mapData[a]);var a=$(this).attr("data-mid");(chat=b.mapData[a])&&WE.pageChat.setReply(chat)})},append:function(a){this.mapData[a._id]=a;$("#timeline-talks").append(WE.kit.tmpl(this.tmpl,a));$("#timeline-bar").scrollTop(99999)},
appends:function(a){for(var b=0,c=a.length,d="";b<c;b++)this.mapData[a[b]._id]=a[b],d+=WE.kit.tmpl(this.tmpl,a[b]);$("#timeline-talks").append(d);a[c-1].time?WE.pageChat.lastTime=a[c-1].time:console.log("lastTime \u5931\u8d25")}};
WE.pageChat.userlist={tmpl:'<li id="uid_<%=_id%>" <% if( _id == USER._id){ %> class="me" <% } %>>\t\t\t\t<a href="/user/<%=_id%>" target="_blank">\t\t\t\t\t<img src="<%=avatar%>"><%=name%>\t\t\t\t</a>\t\t\t\t<% if( _id != USER._id ){ %>\t\t\t\t<a href="javascript:;" title="\u9080\u8bf7\u52a0\u5165\u79c1\u5bc6\u804a\u5929" class="icon-talk"></a>\t\t\t\t<% } %>\t\t\t</li>',data:null,init:function(a){var b=0,c="";if(a){for(this.data=a;b<a.length;b++)c+=WE.kit.tmpl(this.tmpl,a[b]);$("#user-list").empty().html(c)}},
append:function(a){if(a._id!=USER._id){this.data?this.data.push(a):this.data=[a];var b=WE.kit.tmpl(this.tmpl,a);b.addClass("insert-li");setTimeout(function(){b.removeClass("insert-li")},300);$("#user-list").append(b)}},remove:function(a){var b=this.data;$("#uid_"+a._id).remove();for(var c=0;c<b.length;c++)if(b[c]._id==a._id){b.splice(c,1);break}}};
WE.pageChat.historylist={isLoadData:!1,tmpl:'<li>\t\t\t    <a href="/user/<%=_id%>" target="_blank" title="<%=name%>">\t\t\t\t\t<img src="<%=avatar%>">\t\t\t\t</a>\t\t    </li>',init:function(){this.ui={wall:$("#history"),list:$("#history-list"),activeBtn:$("#history-btn"),hideBtn:$("#history-hide")};this.regEvent()},regEvent:function(){var a=this;this.ui.activeBtn.click(function(){a.displayHistory()});this.ui.hideBtn.click(function(){a.hideHistory()})},displayHistory:function(){var a=this;if(!this.isLoadData){var b=
new WE.api.ChatModel,c=new WE.Controller;c.update=function(b){var b=b.data,c="";if(b.code==0){a.isLoadData=!0;for(var e=0;e<b.result.length;e++)c+=WE.kit.tmpl(a.tmpl,b.result[e]);a.ui.list.empty().html(c)}};b.addObserver(c);b.historyList(ROOM.id)}setTimeout(function(){a.ui.hideBtn.css("top","0px")},500);this.ui.wall.css("top","0px")},hideHistory:function(){var a=this;this.ui.hideBtn.css("top","-30px");setTimeout(function(){a.ui.wall.css("top","100%")},500)}};
