WE.pageChat={isLoading:0,lastTime:null,postui:null,init:function(){this.ui={header:$("#header"),postBox:$("#postbox"),postBoxIn:$("#postboxIn")};this.regEvent();WE.pageChat.userlist.historyList(ROOM.id)},regEvent:function(){var a=this;$("#setting").click(function(){a.setRoomInfo(ROOM)});$("#user-Avator").click(function(){a.selectAvatar(USER)});$(window).bind("scroll",function(){if(a.isLoading==0&&$(window).scrollTop()+$(window).height()+100>$(document.body).innerHeight())a.isLoading=1,a.getMore()});
$("#text-tip").click(function(){WE.pageTop.showTextTips()});this.postui=new WE.ui.Post("#wepost");this.postui.onpost=function(c,b,d){a.post(c,b,d)}},post:function(a,c,b){this.postui.setLock();aim=!b?void 0:b;var d=this,b=new WE.api.ChatModel,e=new WE.Controller;e.update=function(a){a.data.code==0&&(d.postui.removeLock(),d.postui.setClear(),d.postui.removeReply(),d.postui.setMini())};b.addObserver(e);b.postChat(a,c,aim)},setRoomInfo:function(a){var c=new WE.Dialog({title:"\u4fee\u6539\u623f\u95f4\u4fe1\u606f",
id:"setRoom",width:500,height:300});c.show();WE.kit.getTmpl("set_room.ejs",function(b){var d=!0,b=WE.kit.tmpl(b,a);c.append(b);var e=$("#roomName"),k=$("#roomTopic"),l=$("#roomDes"),m=$("#roomid"),g=$("#roomPwd"),b=$("#isSetLimit"),f=$("#updateRoomForm");b.change(function(){$("input[type='checkbox']").is(":checked")?g.show():(g.val(""),g.hide())});e.keyup(function(){var a=$("#roomName-tip");a.text();var b=$.trim(e.val());a.text(document.location.host+"/"+b)});e.blur(function(){var a=$.trim(e.val());
if(a!=ROOM.name&&a!=""){var b=new WE.api.ChatModel,c=new WE.Controller;c.update=function(a){a=a.data;e.removeClass("error");a.code==0?(d=!0,f.find(".keyerror").hide(),e.removeClass("error")):(d=!1,f.find(".keyerror").text(a.msg).show(),e.addClass("error"))};b.addObserver(c);b.uniqueKey(a)}else a==""?(d=!1,f.find(".keyerror").text("\u8bbf\u95ee\u5730\u5740\u4e0d\u80fd\u4e3a\u7a7a").show(),e.addClass("error")):(d=!0,f.find(".keyerror").hide(),e.removeClass("error"))});f.submit(function(){var a=m.val(),
b=e.val(),f=k.val(),h=l.val(),n=g.val(),b=b==a?"":b;if(f&&h&&d){var i=new WE.api.ChatModel,j=new WE.Controller;j.update=function(d){d.data.code==0&&(c.close(),setTimeout(function(){window.location.href="http://"+window.location.host+"/"+(b||a)},500))};i.addObserver(j);i.updateRoom(a,b,f,h,n)}return!1})})},getMore:function(){$("#timelineLoading").removeClass("hidden");var a=this,c=new WE.api.ChatModel,b=new WE.Controller;b.update=function(b){$("#timelineLoading").addClass("hidden");b=b.data;b.code==
0&&b.result.length?(a.isLoading=0,WE.pageChat.timeLine.appends(b.result)):a.isLoading=2};b.error=function(){$("#timelineLoading").addClass("hidden")};c.addObserver(b);c.getMore(ROOM.id,this.lastTime)},selectAvatar:function(a){function c(){var a=WE.kit.getRadioValue("gravatarAvatar"),b=new WE.api.ChatModel,c=new WE.Controller;c.update=function(a){a.data.code==0&&document.location.reload()};b.addObserver(c);b.updateAvator(a)}var b=a.hexMail,d=new WE.Dialog({title:"\u9009\u62e9\u5934\u50cf",id:"selectAvatar"});
d.show();WE.kit.getTmpl("select_avatar.ejs",function(e){d.append(e);$("#"+a.gravatarDefault).attr("checked","checked");$("#setAvator").submit(function(){c();return!1});$("#setAvator li img").each(function(){$(this).attr("src",WE.kit.getAvatar(b,48,$(this).data("avatar")))})})}};
WE.pageChat.timeLine={tmpl:'<div class="chat <% if(from._id == USER._id){ %> my <%}%>">\t\t<div class="dot"></div>\t\t<div class="photo">\t\t\t<a href="/user/<%=from._id%>" target="_blank" data-uid="<%=from._id%>" >\t\t\t\t<img src="<%=from.avatar%>" alt="<%=from.name%>" class="avatar" />\t\t\t</a>\t\t</div>\t\t<div class="info">\t\t\t<div class="head">\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" class="name"><%=from.name%></a>\t\t\t\t<a href="/d/<%=_id%>" target="_blank" class="time"><%=WE.kit.format( new Date( time*1000 ),"MM-dd hh:mm:ss" )%></a>\t\t\t</div>\t\t\t<div class="context">\t\t\t\t<%if(obj.aim){%>\t\t\t\t<div class="reply-quote"><%=aim.text%></div>\t\t\t\t<%}%>\t\t\t\t<div class="reply-mine"><%=WE.markdown.format(text)%> <a class="chat-reply" href="javascript:;" data-mid="<%=_id%>" >\u56de\u590d</a></div>\t\t\t</div>\t\t</div>\t</div>',mapData:{},
init:function(a){for(var c=this,b=0,d=a.length;b<d;b++)this.mapData[a[b]._id]=a[b];d&&a[d-1].time?WE.pageChat.lastTime=a[d-1].time:(WE.pageChat.isLoading=2,WE.pageChat.lastTime=-1);$("#timelineChats").delegate(".chat-reply","click",function(){var a=$(this).attr("data-mid");(chat=c.mapData[a])&&WE.pageChat.postui.setReply(chat)})},prepend:function(a){this.mapData[a._id]=a;$("#timelineChats").prepend(WE.kit.tmpl(this.tmpl,a))},appends:function(a){for(var c=0,b=a.length,d="";c<b;c++)this.mapData[a[c]._id]=
a[c],d+=WE.kit.tmpl(this.tmpl,a[c]);$("#timelineChats").append(d);a[b-1].time?WE.pageChat.lastTime=a[b-1].time:console.log("lastTime \u5931\u8d25")}};
WE.pageChat.userlist={tmpl:'<li id="uid_<%=_id%>"><a href="/user/<%=_id%>" target="_blank" title="<%=name%>">\t<img src="<%=avatar%>" width="32" class="avatar" />\t</a></li>',data:null,init:function(a){var c=0,b="";if(a){for(this.data=a;c<a.length;c++)b+=WE.kit.tmpl(this.tmpl,a[c]);$("#userlist").empty().html(b)}},regEvent:function(){},append:function(a){if(a._id!=USER._id)this.data?this.data.push(a):this.data=[a],$("#userlist").append(WE.kit.tmpl(this.tmpl,a))},remove:function(a){var c=this.data;
$("#uid_"+a._id).remove();for(var b=0;b<c.length;b++)if(c[b]._id==a._id){c.splice(b,1);break}},historyList:function(a){var c=this,b=new WE.api.ChatModel,d=new WE.Controller;d.update=function(a){var a=a.data,b="";if(a.code==0){for(var d=0;d<a.result.length;d++)b+=WE.kit.tmpl(c.tmpl,a.result[d]);$("#history-list").empty().html(b)}};b.addObserver(d);b.historyList(a)}};
WE.pageChat.notice={newsNum:0,hidden:!1,title:document.title,init:function(){var a=this;$(document).click(function(){a.restoreTitle();a.hidden=!1});$(window).blur(function(){a.hidden=!0});$(window).focus(function(){a.restoreTitle();a.hidden=!1})},restoreTitle:function(){document.title=this.title},onUpdate:function(){this.hidden?(this.newsNum++,this.addNews()):(this.newsNum=0,this.restoreTitle!=document.title&&this.restoreTitle())},addNews:function(){document.title="("+this.newsNum+") "+this.title}};
