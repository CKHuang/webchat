WE.pageChat={isLoading:0,lastTime:null,replyTo:null,init:function(){this.ui={postBox:$("#post-box"),replayBox:$("#replay-box")};this.regEvent()},regEvent:function(){var a=this;this.ui.postBox.find(".text-box input").keyup(function(b){13==b.keyCode&&(b=$.trim($(this).val()),""!=b&&a.post(ROOM.id,b,a.replyTo))});$("#timeline-bar").bind("scroll",function(){var b=$(this);0==a.isLoading?0==b.scrollTop()&&0<WE.pageChat.timeLine.leave_count&&(a.isLoading=1,a.getMore()):2==a.isLoading&&0==b.scrollTop()&&
a.noMoreTips()})},tipsTimeout:null,noMoreTips:function(){console.log("noMoreTips");clearTimeout(this.tipsTimeout);$("#more-talks .tips").text("\u6ca1\u6709\u66f4\u591a\u4fe1\u606f\u4e86...");$("#more-talks").fadeIn();this.tipsTimeout=setTimeout(function(){$("#more-talks").fadeOut()},2E3)},getMore:function(){$("#more-talks").fadeIn();var a=this,b=new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){var c=b.data;setTimeout(function(){0==c.code&&c.result.length?(a.isLoading=0,WE.pageChat.timeLine.leave_count-=
c.result.length,WE.pageChat.timeLine.prepends(c.result)):a.isLoading=2;$("#more-talks").fadeOut()},500)};c.error=function(){$("#more-talks").fadeOut()};b.addObserver(c);b.getMore(ROOM.id,this.lastTime)},post:function(a,b,c){aim=null==c?void 0:c;var d=this;c=new WE.api.RoomModel;var e=new WE.Controller;e.update=function(a){0==a.data.code&&(d.ui.postBox.find(".text-box input").val(""),d.hideReply());d.replyTo=null};c.addObserver(e);c.postChat(a,b,aim)},setReply:function(a){var b=this;this.replyTo=a._id;
this.ui.replayBox.html(WE.kit.tmpl(this.replyTmpl,a));this.ui.replayBox.removeClass("hidden");this.ui.replayBox.find(".close-btn").click(function(){b.ui.replayBox.empty();b.ui.replayBox.addClass("hidden")});this.ui.postBox.find(".text-box input").focus()},hideReply:function(){this.ui.replayBox.empty();this.ui.replayBox.addClass("hidden")},replyTmpl:'<div class="replay-box">\t\t\t\t\t<div class="arrow"></div>\t\t\t\t\t<span class="icon-close close-btn"></span>\t\t\t\t\t<div>\t\t\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" class="name"><%=from.name == ""? "(\u6682\u65e0\u6635\u79f0)" : from.name %></a> : \t\t\t\t\t</div>\t\t\t\t\t<div class="context"><%=text %></div>\t\t\t\t</div>'};
WE.pageChat.login={isLogin:!1,init:function(){this.ui={nickNameInput:$("#login-nickname-input"),nickNameBtn:$("#login-nickname-btn"),nickNameWall:$("#login-nickname-wall")};this.regEvent()},regEvent:function(){var a=this;this.ui.nickNameInput.keyup(function(b){var c=$.trim(a.ui.nickNameInput.val());""!=c?a.ui.nickNameBtn.find(".icon-go").addClass("icon-go-click"):a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click");13!=b.keyCode||""==c||a.isLogin||(a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click"),
a.nickNameLogin(c))});this.ui.nickNameBtn.click(function(){var b=$.trim(a.ui.nickNameInput.val());""!=b&&(a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click"),a.nickNameLogin(b))})},nickNameLogin:function(a){var b=this;b.isLogin=!0;b.ui.nickNameBtn.find(".icon-go").addClass("hidden");b.ui.nickNameBtn.find(".icon-loading").removeClass("hidden");var c=new WE.api.UserModel,d=new WE.Controller;d.update=function(a){0==a.data.code&&(console.log(b.connectSocket),$("#wall-room").removeClass("login-style"),
location.reload());setTimeout(function(){b.isLogin=!1;b.ui.nickNameBtn.find(".icon-go").removeClass("hidden");b.ui.nickNameBtn.find(".icon-loading").addClass("hidden")},1E3)};c.addObserver(d);c.updateUserName(a)}};
WE.pageChat.timeLine={tmpl:'<div class="talk <% if( from._id == USER._id ){ %> me <% } %>">\t\t\t\t<div class="photo">\t\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" data-uid="<%=from._id%>">\t\t\t\t\t\t<img src="<%=from.avatar%>">\t\t\t\t\t</a>\t\t\t\t</div>\t\t\t\t<div class="info">\t\t\t\t\t<div class="head">\t\t\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" class="name <% if(from.name==""){ %> no-name <% } %>"><%= from.name == ""? "(\u6682\u65e0\u6635\u79f0)" : from.name %></a>\t\t\t\t\t\t<a target="_blank" href="/d/<%=_id%>" class="time">\t\t\t\t\t\t\t<%=WE.kit.weFormat( time*1000 ) %>\t\t\t\t\t\t</a>\t\t\t\t\t</div>\t\t\t\t\t<% if(obj.aim){ %>\t\t\t\t\t<div class="reply"><%=aim.text%></div>\t\t\t\t\t<% } %>\t\t\t\t\t<div class="context">\t\t\t\t\t\t<%=WE.markdown.format(text)%><a href="javascript:;" data-mid="<%=_id%>" class="icon-reply chat-reply" title="\u56de\u590d"></a>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t</div>',mapData:{},
init:function(a,b){var c=this,d=0,e=a.length;c.chats_count=b;for(c.leave_count=30<b?b-30:0;d<e;d++)this.mapData[a[d]._id]=a[d];this.appends(a);e&&a[0].time?WE.pageChat.lastTime=a[0].time:(WE.pageChat.isLoading=2,WE.pageChat.lastTime=-1);$("#timeline-talks").delegate(".chat-reply","click",function(){console.log("_this.mapData[id]",c.mapData[a]);var a=$(this).attr("data-mid");(chat=c.mapData[a])&&WE.pageChat.setReply(chat)})},append:function(a){this.mapData[a._id]=a;$("#timeline-talks").append(WE.kit.tmpl(this.tmpl,
a));$("#timeline-bar").scrollTop(99999)},appends:function(a){for(var b=0,c=a.length,d="";b<c;b++)this.mapData[a[b]._id]=a[b],d+=WE.kit.tmpl(this.tmpl,a[b]);$("#timeline-talks").append(d);a[0]&&a[0].time?WE.pageChat.lastTime=a[0].time:console.log("lastTime \u5931\u8d25");$("#timeline-bar").scrollTop(99999)},prepends:function(a){for(var b=0,c=a.length,d="";b<c;b++)this.mapData[a[b]._id]=a[b],d+=WE.kit.tmpl(this.tmpl,a[b]);b=$(d);b.insertAfter($("#more-talks"));var e=0;$.each(b,function(a,b){e+=b.offsetHeight});
$("#timeline-bar").scrollTop(e-20);a[0].time?WE.pageChat.lastTime=a[0].time:console.log("lastTime \u5931\u8d25")}};
WE.pageChat.userlist={tmpl:'<li id="uid_<%=_id%>" class="<% if( _id == USER._id){ %> me <% } %><% if( typeof obj.online != "undefined" ){ %> insert-li <% } %>" >\t\t\t\t<a href="/user/<%=_id%>" target="_blank"  class="name <% if(name == ""){ %>no-name<% } %>" >\t\t\t\t\t<img src="<%=avatar%>"><%= name == ""? "(\u6682\u65e0\u6635\u79f0)" : name%>\t\t\t\t</a>\t\t\t\t<% if( _id != USER._id ){ %>\t\t\t\t<a href="javascript:;" title="\u9080\u8bf7\u52a0\u5165\u79c1\u5bc6\u804a\u5929" class="icon-talk"></a>\t\t\t\t<% } %>\t\t\t</li>',data:null,
init:function(a){var b=0,c="";if(a){for(this.data=a;b<a.length;b++)c+=WE.kit.tmpl(this.tmpl,a[b]);$("#user-list").empty().html(c)}},append:function(a){if(a._id!=USER._id){this.data?this.data.push(a):this.data=[a];a.online=!0;var b=WE.kit.tmpl(this.tmpl,a);setTimeout(function(){$("#uid_"+a._id).removeClass("insert-li")},300);$("#user-list").append(b)}},remove:function(a){var b=this.data;$("#uid_"+a._id).remove();for(var c=0;c<b.length;c++)if(b[c]._id==a._id){b.splice(c,1);break}}};
WE.pageChat.historylist={isLoadData:!1,tmpl:'<li>\t\t\t    <a href="/user/<%=_id%>" target="_blank" title="<%=name%>">\t\t\t\t\t<img src="<%=avatar%>">\t\t\t\t</a>\t\t    </li>',init:function(){this.ui={wall:$("#history"),list:$("#history-list"),activeBtn:$("#history-btn"),hideBtn:$("#history-hide")};this.regEvent()},regEvent:function(){var a=this;this.ui.activeBtn.click(function(){a.displayHistory()});this.ui.hideBtn.click(function(){a.hideHistory()})},displayHistory:function(){var a=this;if(!this.isLoadData){var b=
new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){b=b.data;var c="";if(0==b.code){a.isLoadData=!0;for(var f=0;f<b.result.length;f++)c+=WE.kit.tmpl(a.tmpl,b.result[f]);a.ui.list.empty().html(c)}};b.addObserver(c);b.historyList(ROOM.id)}setTimeout(function(){a.ui.hideBtn.css("top","0px")},500);this.ui.wall.css("top","0px")},hideHistory:function(){var a=this;this.ui.hideBtn.css("top","-30px");setTimeout(function(){a.ui.wall.css("top","100%")},500)}};
WE.pageChat.invite={selectList:{mail:[],user:[]},datas:[],isGetData:!1,mailInputList:[],init:function(){var a=$("#invite");this.ui={wall:$("#wall-room"),inviteWall:a,boot:$("#invite-btn"),close:a.find(".js-close-btn"),usersList:$("#users-list"),emailInput:a.find(".email-input"),emailTips:a.find(".email-input .error-tips")};this.regEvent()},regEvent:function(){var a=this;this.ui.boot.click(function(){a.ui.wall.addClass("invite-style");a.isGetData?a.addUsers(a.datas):a.getUserList()});this.ui.close.click(function(){a.ui.wall.removeClass("invite-style");
a.ui.usersList.empty();a.ui.emailInput.find("input").val("");a.selectList.mail=[];a.selectList.user=[]});this.ui.usersList.find(".cell").click(function(){var a=$(this);a.index();var c=a.hasClass("select-cell");c?a.removeClass("select-cell"):a.addClass("select-cell");c?a.find(".select").addClass("hidden"):a.find(".select").removeClass("hidden");c?a.find(".invite").show():a.find(".invite").hide()});this.ui.emailInput.find("input").keyup(function(b){var c=$.trim(a.ui.emailInput.find("input").val());
if(13==b.keyCode&&""!=c){if(!/^[^@]+@[^@]+$/.test(c))return a.ui.emailTips.text("Please input email").show(),setTimeout(function(){a.ui.emailTips.hide()},2E3),!1;b=a.selectList.mail.length;for(var d=a.selectList.mail,e=!1,f=0;f<b;f++)if(d[f].mail==c){e=!0;a.ui.emailTips.text("Email already exists").show();setTimeout(function(){a.ui.emailTips.hide()},2E3);break}e||a.addUser({mail:c},!0);a.ui.emailInput.find("input").val("")}});this.ui.emailInput.find("input").focus(function(){a.ui.emailTips.hide()})},
addUser:function(a,b){(new WE.pageChat.inviteCell(a,b)).prepend(this.ui.usersList)},addUsers:function(a){for(var b=a.length,c=0;c<b;c++)this.addUser(a[c].to,!1)},getUserList:function(){var a=this,b=new WE.api.UserModel,c=new WE.Controller;c.update=function(b){b=b.data;0==b.code&&(a.isGetData=!0,a.datas=b.result,a.addUsers(a.datas))};b.addObserver(c);b.getContactList()}};
WE.pageChat.inviteCell=function(a,b){this.data=a;this.select=b||!1;this.list=(this.isUserList="undefined"!=typeof a.name?!0:!1)?WE.pageChat.invite.selectList.user:WE.pageChat.invite.selectList.mail;this.listIndex=this.list.length;var c=WE.kit.tmpl(this.itemTmpl,{user:this.data,select:b});wall=$(c);this.ui={wall:wall,invite:wall.find(".invite-js-btn"),cell:wall.find(".cell")};this.select&&this.addUser();this.init()};
WE.pageChat.inviteCell.prototype={itemTmpl:'<li>\t\t\t\t<div class="cell <% if( select ){ %> select-cell <% } %>">\t\t\t\t\t<% if( typeof user.avatar != "undefined" ){ %>\t\t\t\t\t<img src="<%=user.avatar %>">\t\t\t\t\t<% } %>\t\t\t\t\t<%=user.name || user.mail %>\t\t\t\t\t<% if( select ){ %>\t\t\t\t\t\t<div class="invite-js-btn">\t\t\t\t\t\t\t<span class="select select-type">\u221a</span>\t\t\t\t\t\t\t<span class="btn invite-type invite" style="display:none;">Invite</span>\t\t\t\t\t\t</div>\t\t\t\t\t<% }else{ %>\t\t\t\t\t\t<div class="invite-js-btn">\t\t\t\t\t\t\t<span class="select select-type hidden">\u221a</span>\t\t\t\t\t\t\t<span class="btn invite-type invite">Invite</span>\t\t\t\t\t\t</div>\t\t\t\t\t<% } %>\t\t\t\t</div>\t\t\t</li>',init:function(){this.regEvent()},
regEvent:function(){var a=this;this.ui.cell.click(function(){a.select=!0==a.select?!1:!0;a.select?(a.ui.invite.find(".select-type").removeClass("hidden"),a.ui.invite.find(".invite-type").hide(),a.ui.cell.addClass("select-cell"),a.addUser()):(a.ui.invite.find(".select-type").addClass("hidden"),a.ui.invite.find(".invite-type").show(),a.ui.cell.removeClass("select-cell"),a.removeUser())})},prepend:function(a){a.prepend(this.ui.wall)},addUser:function(){this.isUserList?this.list.push(this.data._id):this.list.push(this.data)},
removeUser:function(){for(var a=this.list.length,b=0;b<a;b++)this.isUserList?this.data._id&&this.data._id==this.list[b]._id&&this.list.splice(b,1):this.data.mail&&this.data.mail==this.list[b].mail&&this.list.splice(b,1)}};
