WE.api=WE.api||{};WE.api.ChatModel=function(){this.postUrl="?1";this.setUserNameURL="/sys/set_user_name";this.updateRoomURL="/sys/update_room";this.updateAvatorURL="/sys/set_avatar";this.historyListURL="/sys/history";this.uniqueKeyURL="/sys/check_room_key"};WE.api.ChatModel.prototype=WE.BaseModel.prototype;WE.api.ChatModel.prototype.postChat=function(a,c,b){this.post(this.postUrl,{roomid:a,text:c,to:b})};WE.api.ChatModel.prototype.updateUserName=function(a){this.post(this.setUserNameURL,{name:a})};
WE.api.ChatModel.prototype.updateRoom=function(a,c,b,d){this.post(this.updateRoomURL,{id:a,name:c,topic:b,des:d})};WE.api.ChatModel.prototype.getMore=function(a,c){this.get("/sys/getmore",{roomid:a,time:c})};WE.api.ChatModel.prototype.updateMailPwd=function(a,c){this.post("/sys/bindmail",{mail:a,pwd:c})};WE.api.ChatModel.prototype.updateAvator=function(a){this.post(this.updateAvatorURL,{gravatarDefault:a})};
WE.api.ChatModel.prototype.historyList=function(a){this.get(this.historyListURL,{roomid:a,size:24})};WE.api.ChatModel.prototype.uniqueKey=function(a){this.get(this.uniqueKeyURL,{key:a})};WE.pageChat={isLoading:0,lastTime:null,postType:1,init:function(){this.ui={header:$("#header"),postBox:$("#postbox"),postBoxIn:$("#postboxIn")};this.regEvent();$("#postText").focus();WE.pageChat.reply.init();WE.pageChat.userlist.historyList(ROOM.id)},regEvent:function(){var a=this;$("#postForm").submit(function(){var c=$.trim($("#postText").val()).replace(/[\n\r]+$/g,""),b=$("#roomid").val();c&&b?a.post(b,c,WE.pageChat.reply._id):$("#postText").val("").focus();return!1});$("#setting").click(function(){a.setRoomInfo(ROOM)});
$("#user-Avator").click(function(){a.selectAvatar(USER)});$(window).bind("scroll",function(){if(a.isLoading==0&&$(window).scrollTop()+$(window).height()+100>$(document.body).innerHeight())a.isLoading=1,a.getMore()})},post:function(a,c,b){$("#postTypeGroup button").attr("disabled","disabled").text("\u53d1\u9001\u4e2d...");var b=!b?void 0:b,d=new WE.api.ChatModel,e=new WE.Controller;e.update=function(a){a.data.code==0&&($("#postText").val("").focus(),$("#postTypeGroup button").removeAttr("disabled").text("\u53d1\u9001"),
WE.pageChat.reply.delOrig())};d.addObserver(e);d.postChat(a,c,b)},setRoomInfo:function(a){var c=new WE.Dialog({title:"\u4fee\u6539\u623f\u95f4\u4fe1\u606f",id:"setRoom",width:500,height:300});c.show();WE.kit.getTmpl("set_room.ejs",function(b){var d=!0,b=WE.kit.tmpl(b,a);c.append(b);var e=$("#roomName"),j=$("#roomTopic"),k=$("#roomDes"),l=$("#roomid"),f=$("#updateRoomForm");e.keyup(function(){var a=$("#roomName-tip");a.text();var c=$.trim(e.val());a.text(document.location.host+"/"+c)});e.blur(function(){var a=
$.trim(e.val());if(a!=ROOM.name&&a!=""){var c=new WE.api.ChatModel,b=new WE.Controller;b.update=function(a){a=a.data;e.removeClass("error");a.code==0?(d=!0,f.find(".keyerror").hide(),e.removeClass("error")):(d=!1,f.find(".keyerror").text(a.msg).show(),e.addClass("error"))};c.addObserver(b);c.uniqueKey(a)}else a==""?(d=!1,f.find(".keyerror").text("\u8bbf\u95ee\u5730\u5740\u4e0d\u80fd\u4e3a\u7a7a").show(),e.addClass("error")):(d=!0,f.find(".keyerror").hide(),e.removeClass("error"))});f.submit(function(){var a=
l.val(),b=e.val(),f=j.val(),g=k.val(),b=b==a?"":b;if(f&&g&&d){var h=new WE.api.ChatModel,i=new WE.Controller;i.update=function(d){d.data.code==0&&(c.close(),setTimeout(function(){window.location.href="http://"+window.location.host+"/"+(b||a)},500))};h.addObserver(i);h.updateRoom(a,b,f,g)}return!1})})},getMore:function(){$("#timelineLoading").removeClass("hidden");var a=this,c=new WE.api.ChatModel,b=new WE.Controller;b.update=function(b){$("#timelineLoading").addClass("hidden");b=b.data;b.code==0&&
b.result.length?(a.isLoading=0,WE.pageChat.timeLine.appends(b.result)):a.isLoading=2};b.error=function(){$("#timelineLoading").addClass("hidden")};c.addObserver(b);c.getMore(ROOM.id,this.lastTime)},selectAvatar:function(a){function c(){var a=WE.kit.getRadioValue("gravatarAvatar"),b=new WE.api.ChatModel,c=new WE.Controller;c.update=function(a){a.data.code==0&&document.location.reload()};b.addObserver(c);b.updateAvator(a)}var b=a.hexMail,d=new WE.Dialog({title:"\u9009\u62e9\u5934\u50cf",id:"selectAvatar"});
d.show();WE.kit.getTmpl("select_avatar.ejs",function(e){d.append(e);$("#"+a.gravatarDefault).attr("checked","checked");$("#setAvator").submit(function(){c();return!1});$("#setAvator li img").each(function(){$(this).attr("src",WE.kit.getAvatar(b,48,$(this).data("avatar")))})})}};
WE.pageChat.timeLine={tmpl:'<div class="chat">\t\t<div class="dot"></div>\t\t<div class="photo">\t\t\t<a href="#" data-uid="<%=uid%>" >\t\t\t\t<img src="<%=uavatar%>" alt="<%=uname%>" class="avatar" />\t\t\t</a>\t\t</div>\t\t<div class="info">\t\t\t<div class="head">\t\t\t\t<a href="#" class="name" data-uid="<%=uid%>" ><%=uname%></a>\t\t\t\t<span class="time"><%=WE.kit.format( new Date( time*1000 ),"MM-dd hh:mm:ss" )%></span>\t\t\t</div>\t\t\t<div class="context">\t\t\t\t<%if(obj.to){%>\t\t\t\t<div class="reply-quote"><%=to.text%> <a href="#"><%= to.uname%></a></div>\t\t\t\t<%}%>\t\t\t\t<div><%=text %> <a data-mtx="<%=text%>" data-uid="<%=uname%>" data-mid="<%=_id%>" class="chat-reply" href="javascript:void(0);">\u56de\u590d</a></div>\t\t\t</div>\t\t</div>\t</div>',init:function(a){for(var c=
0,b=a.length,d="";c<b;c++)d+=WE.kit.tmpl(this.tmpl,a[c]);$("#timelineChats").html(d);b&&a[b-1].time?WE.pageChat.lastTime=a[b-1].time:(WE.pageChat.isLoading=2,WE.pageChat.lastTime=-1)},prepend:function(a){$("#timelineChats").prepend(WE.kit.tmpl(this.tmpl,a))},appends:function(a){for(var c=0,b=a.length,d="";c<b;c++)d+=WE.kit.tmpl(this.tmpl,a[c]);$("#timelineChats").append(d);a[b-1].time?WE.pageChat.lastTime=a[b-1].time:console.log("lastTime \u5931\u8d25")}};
WE.pageChat.userlist={tmpl:'<li id="uid_<%=_id%>"><a href="#" title="<%=name%>">\t<img src="<%=avatar%>" width="32" class="avatar" />\t</a></li>',data:null,init:function(a){var c=0,b="";if(a){for(this.data=a;c<a.length;c++)b+=WE.kit.tmpl(this.tmpl,a[c]);$("#userlist").empty().html(b)}},regEvent:function(){},append:function(a){if(a._id!=USER._id)this.data?this.data.push(a):this.data=[a],$("#userlist").append(WE.kit.tmpl(this.tmpl,a))},remove:function(a){var c=this.data;$("#uid_"+a._id).remove();for(var b=
0;b<c.length;b++)if(c[b]._id==a._id){c.splice(b,1);break}},historyList:function(a){var c=this,b=new WE.api.ChatModel,d=new WE.Controller;d.update=function(a){var a=a.data,b="";if(a.code==0){for(var d=0;d<a.result.length;d++)b+=WE.kit.tmpl(c.tmpl,a.result[d]);$("#history-list").empty().html(b)}};b.addObserver(d);b.historyList(a)}};
WE.pageChat.reply={_id:null,init:function(){this.setUi();this.regEvent()},regEvent:function(){var a=this;this.ui.listCon.delegate(a.ui.replyBtnClass,"click",function(c){a.ui.origCon.show();var c=$(c.target),b=c.attr("data-mtx"),d=c.attr("data-uid");a._id=c.attr("data-mid");a.ui.to.val(a._id);a.setReply(b,d);$("body").animate({scrollTop:0},600);a.ui.inputText.focus()});this.ui.delBtn.click(a.delOrig)},setUi:function(){var a=$("#quote");this.ui={listCon:$("#timelineChats"),origCon:a,origText:a.find(".quote-text"),
origUser:a.find(".quote-user"),delBtn:a.find(".quote-del"),replyBtnClass:".chat-reply",to:$("#to"),inputText:$("#postText")}},setReply:function(a,c){var b=WE.pageChat.reply;b.ui.origText.text(a);b.ui.origUser.text(c)},delOrig:function(){var a=WE.pageChat.reply;a.ui.origText.text("");a.ui.origUser.text("");a.ui.to.val("");a._id=null;a.ui.origCon.hide()}};
