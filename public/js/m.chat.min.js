WE.api=WE.api||{};WE.api.ChatModel=function(){this.postUrl="?1";this.setUserNameURL="/sys/set_user_name";this.updateRoomURL="/sys/room_update";this.updateAvatorURL="/sys/set_avatar";this.historyListURL="/sys/history";this.uniqueKeyURL="/sys/check_room_key";this.mpostUrl=location.pathname.replace("/m/","/")};WE.api.ChatModel.prototype=WE.BaseModel.prototype;WE.api.ChatModel.prototype.mpostChat=function(a,b,c){a={roomid:a,text:b};if(c)a.to=c;this.post(this.mpostUrl,a)};
WE.api.ChatModel.prototype.postChat=function(a,b,c){this.post(this.postUrl,{roomid:a,text:b,to:c})};WE.api.ChatModel.prototype.updateUserName=function(a){this.post(this.setUserNameURL,{name:a})};WE.api.ChatModel.prototype.updateRoom=function(a,b,c,d,e){this.post(this.updateRoomURL,{id:a,name:b,topic:c,des:d,password:e})};WE.api.ChatModel.prototype.getMore=function(a,b){this.get("/sys/getmore",{roomid:a,time:b})};
WE.api.ChatModel.prototype.updateMailPwd=function(a,b){this.post("/sys/bindmail",{mail:a,pwd:b})};WE.api.ChatModel.prototype.updateAvator=function(a){this.post(this.updateAvatorURL,{gravatarDefault:a})};WE.api.ChatModel.prototype.historyList=function(a){this.get(this.historyListURL,{roomid:a,size:24})};WE.api.ChatModel.prototype.uniqueKey=function(a){this.get(this.uniqueKeyURL,{key:a})};WE.pageChat={chatTmpl:'<% for(var i = 0;i<obj.length;i++){ %>\t\t\t\t\t<div class="chat <% if(obj[i].uid == USER._id){ %> my <% } %>">\t\t\t\t\t\t<input name="uid" type="hidden" value="<%=obj[i].uid%>"/>\t\t\t\t\t\t<input name="txt" type="hidden" value="<%=obj[i].text%>"/>\t\t\t\t\t\t<input name="uname" type="hidden" value="<%=obj[i].uname%>"/>\t\t\t\t\t\t<input name="mid" type="hidden" value="<%=obj[i]._id%>"/>\t\t\t\t\t\t<div class="avator">\t\t\t\t\t\t\t<a href="/user/<%=obj[i].uid%>">\t\t\t\t\t\t\t\t<img width="32" height="32" src="<%=obj[i].uavatar%>" alt="<%=obj[i].uname%>"/>\t\t\t\t\t\t\t</a>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="info">\t\t\t\t\t\t\t<div class="talk">\t\t\t\t\t\t\t\t<i class="arrow"></i>\t\t\t\t\t\t\t\t<div class="talk-cont">\t\t\t\t\t\t\t\t\t<% if( obj[i].to ){ %>\t\t\t\t\t\t\t\t\t<div class="review-orig">\t\t\t\t\t\t\t\t\t\t<span><%=WE.kit.chatFormate(obj[i].to.text) %></span>\t\t\t\t\t\t\t\t\t\t<a class="u-name" href="/user/<%=obj[i].to.uid%>"><%=obj[i].to.uname%></a>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t<% } %>\t\t\t\t\t\t\t\t\t<a class="name" href="/user/<%=obj[i].uid%>"><%=obj[i].uname%> : </a><%=WE.kit.chatFormate(obj[i].text)%>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<p class="review-time">\t\t\t\t\t\t\t\t\t<a class="review-btn" href="javascript:;">\u56de\u590d</a>\t\t\t\t\t\t\t\t\t<span class="time"><%=WE.kit.format( new Date( obj[i].time * 1000),"MM-dd hh:mm:ss")%></span>\t\t\t\t\t\t\t\t</p>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t<% } %>',
init:function(){this.ui={backBtn:$("#chat-title .back"),setBtn:$("#chat-title .setting"),container:$("#chat-container"),inputArea:$("#talk-input"),sendBtn:$("#send-btn")};this.regEvent();WE.pageChat.review.init();WE.pageChat.lazyloadData.init()},regEvent:function(){var a=this;this.ui.setBtn.click(function(){alert("\u8bbe\u7f6e\u7684\u6309\u94ae")});$("#sendForm").submit(function(){var b=a.ui.inputArea.val();b&&(console.log(WE.pageChat.review._id),a.post(ROOM.id,b,WE.pageChat.review._id),WE.pageChat.review.clear(),
$("#talk-input").val(""));return!1})},prepend:function(a){a=WE.kit.tmpl(this.chatTmpl,a);$(a).prependTo(this.ui.container)},append:function(a){if(a){var b=WE.kit.tmpl(this.chatTmpl,a);$(b).appendTo(this.ui.container)}(b=a.length)&&a[b-1].time?WE.pageChat.lazyloadData.lastTime=a[b-1].time:(WE.pageChat.lazyloadData.isLoading=2,WE.pageChat.lazyloadData.lastTime=-1)},clear:function(){this.ui.inputArea.val("")},post:function(a,b,c){var d=this;d.ui.sendBtn.attr("disabled","disabled").text("\u53d1\u9001\u4e2d...");
var c=!c?void 0:c,e=new WE.api.ChatModel,f=new WE.Controller;f.update=function(a){if(a.data.code==0)d.review._id=null,d.ui.inputArea.val(""),d.ui.sendBtn.removeAttr("disabled").text("\u53d1\u9001")};e.addObserver(f);e.mpostChat(a,b,c)}};
WE.pageChat.lazyloadData={isLoading:0,lastTime:null,init:function(){this.regEvent()},regEvent:function(){var a=this;$(window).bind("scroll",function(){if(a.isLoading==0&&$(window).scrollTop()+$(window).height()+50>$(document.body).height())a.isLoading=1,a.getMore()})},getMore:function(){var a=this;$("#timeline-loading").show();var b=new WE.api.ChatModel,c=new WE.Controller;c.update=function(b){$("#timeline-loading").hide();b=b.data;b.code==0&&b.result.length?(a.isLoading=0,WE.pageChat.append(b.result)):
a.isLoading=2};c.error=function(){};b.addObserver(c);b.getMore(ROOM.id,this.lastTime)}};
WE.pageChat.review={_id:null,init:function(){this.regEvent()},reviewOrigTmpl:'<p>\t\t\t\t\t\t<span class="review-cont"><%=text%></span>\t\t\t\t\t\t<a class="review-uname" href="/user/<%=uid%>"><%=uname%></a>\t\t\t\t\t\t<a class="review-del" href="javascript:;" style="margin-left:10px;font-weight:bold;">\u00d7</a>\t\t\t\t\t  </p>',regEvent:function(){var a=this;$("#chat-container").delegate(".review-btn","click",function(){var b=$(this).closest(".chat"),c=b.find("input[name=uid]").val();uname=b.find("input[name=uname]").val();
text=b.find("input[name=txt]").val();mid=b.find("input[name=mid]").val();a._id=mid;a.setOrigData(text,uname,c)});$("#review-box").delegate(".review-del","click",function(){a._id=null;a.clear()})},setOrigData:function(a,b,c){var d=$("#review-box");d.empty();a=WE.kit.tmpl(this.reviewOrigTmpl,{text:a,uid:c,uname:b});$(a).appendTo(d)},clear:function(){$("#review-box").empty()}};
