WE.api=WE.api||{};WE.api.ChatModel=function(){this.postUrl="?1";this.setUserNameURL="/sys/set_user_name";this.updateRoomURL="/sys/room_update";this.updateAvatorURL="/sys/set_avatar";this.historyListURL="/sys/history";this.uniqueKeyURL="/sys/check_room_key"};WE.api.ChatModel.prototype=WE.BaseModel.prototype;WE.api.ChatModel.prototype.postChat=function(a,b,c){this.post(this.postUrl,{roomid:a,text:b,to:c})};WE.api.ChatModel.prototype.updateUserName=function(a){this.post(this.setUserNameURL,{name:a})};
WE.api.ChatModel.prototype.updateRoom=function(a,b,c,d,e){this.post(this.updateRoomURL,{id:a,name:b,topic:c,des:d,password:e})};WE.api.ChatModel.prototype.getMore=function(a,b){this.get("/sys/getmore",{roomid:a,time:b})};WE.api.ChatModel.prototype.updateMailPwd=function(a,b){this.post("/sys/bindmail",{mail:a,pwd:b})};WE.api.ChatModel.prototype.updateAvator=function(a){this.post(this.updateAvatorURL,{gravatarDefault:a})};
WE.api.ChatModel.prototype.historyList=function(a){this.get(this.historyListURL,{roomid:a,size:24})};WE.api.ChatModel.prototype.uniqueKey=function(a){this.get(this.uniqueKeyURL,{key:a})};WE.pageChat={chatTmpl:'<% for(var i = 0;i<obj.length;i++){ %>\t\t\t\t\t<div class="chat <% if(uid == USER._id){ %> my <% } %>">\t\t\t\t\t\t<div class="avator">\t\t\t\t\t\t\t<a href="/user/<%=uid%>">\t\t\t\t\t\t\t\t<img src="<%=obj[i].uavatar%>" alt="<%=uname%>"/>\t\t\t\t\t\t\t</a>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="info">\t\t\t\t\t\t\t<a class="name" href="/user/<%=uid%>"><%=uname%> :</a>\t\t\t\t\t\t\t<div class="talk">\t\t\t\t\t\t\t\t<i class="arrow"></i>\t\t\t\t\t\t\t\t<% if( obj[i].review ){ %>\t\t\t\t\t\t\t\t<div class="review-orig">\t\t\t\t\t\t\t\t\t<span><%=WE.kit.chatFormate(to.text) %></span>\t\t\t\t\t\t\t\t\t<a class="u-name" href="/user/<%=to.uid%>"><%=obj[i].to.uname%></a>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<% } %>\t\t\t\t\t\t\t\t<p><%=WE.kit.chatFormate(text)%></p>\t\t\t\t\t\t\t\t<p>\t\t\t\t\t\t\t\t\t<a href="javascript:;">\u56de\u590d</a>\t\t\t\t\t\t\t\t\t<span class="time"><%=WE.kit.format( new Date( time * 1000),"MM-dd hh:mm:ss")%></span>\t\t\t\t\t\t\t\t</p>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t<% } %>',
init:function(){this.ui={backBtn:$("#chat-title .back"),setBtn:$("#chat-title .setting"),container:$("#chat-container"),inputArea:$("#talk-input"),sendBtn:$("#send-btn")};this.regEvent()},regEvent:function(){var a=this;this.ui.setBtn.click(function(){alert("\u8bbe\u7f6e\u7684\u6309\u94ae")});$("#sendForm").submit(function(){a.ui.inputArea.val()&&a.prepend(datas);return!1})},prepend:function(a){a=WE.kit.tmpl(this.chatTmpl,a);$(a).prependTo(this.ui.container)},append:function(a){a=WE.kit.tmpl(this.chatTmpl,
a);$(a).appendTo(this.ui.container)},clear:function(){this.ui.inputArea.val("")},post:function(a,b,c){var d=this;d.ui.sendBtn.attr("disabled","disabled").text("\u53d1\u9001\u4e2d...");var c=!c?void 0:c,e=new WE.api.ChatModel,f=new WE.Controller;f.update=function(a){a.data.code==0&&(d.ui.inputArea.val(""),d.ui.sendBtn.removeAttr("disabled").text("\u53d1\u9001"))};e.addObserver(f);e.postChat(a,b,c)}};
