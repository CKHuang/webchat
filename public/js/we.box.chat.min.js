WE.api=WE.api||{};WE.api.ChatModel=function(){this.postUrl="/post";this.setUserNameURL="/sys/set_user_name";this.updateRoomURL="/sys/room_update";this.updateAvatorURL="/sys/set_avatar";this.historyListURL="/sys/history";this.uniqueKeyURL="/sys/check_room_key";this.mpostUrl=location.pathname.replace("/m/","/")};WE.api.ChatModel.prototype=WE.BaseModel.prototype;WE.api.ChatModel.prototype.mpostChat=function(a,b,c){a={roomid:a,text:b};if(c)a.to=c;this.post(this.mpostUrl,a)};
WE.api.ChatModel.prototype.postChat=function(a,b,c){this.post(this.postUrl,{roomid:a,text:b,to:c})};WE.api.ChatModel.prototype.updateUserName=function(a){this.post(this.setUserNameURL,{name:a})};WE.api.ChatModel.prototype.updateRoom=function(a,b,c,d,e){this.post(this.updateRoomURL,{id:a,name:b,topic:c,des:d,password:e})};WE.api.ChatModel.prototype.getMore=function(a,b){this.get("/sys/getmore",{roomid:a,time:b})};
WE.api.ChatModel.prototype.updateMailPwd=function(a,b){this.post("/sys/bindmail",{mail:a,pwd:b})};WE.api.ChatModel.prototype.updateAvator=function(a){this.post(this.updateAvatorURL,{gravatarDefault:a})};WE.api.ChatModel.prototype.historyList=function(a){this.get(this.historyListURL,{roomid:a,size:24})};WE.api.ChatModel.prototype.uniqueKey=function(a){this.get(this.uniqueKeyURL,{key:a})};WE.boxCaht={replyId:null,init:function(){this.regEvent()},regEvent:function(){var a=this;$("#postText").keydown(function(b){if(b.keyCode==13&&a.postType==2||b.ctrlKey&&b.keyCode==13&&a.postType==1)return $("#postForm").trigger("submit"),!1});$("#postText").keyup(function(){var a=$(this)[0],a=a.innerText||a.textContent,a=String(a).replace(/<\/div>/g,"").replace(/<div>/g,"\n").replace(/<br>/g,"\n");$("#postTextArea").val(a)});$("#postForm").submit(function(){var b=$.trim($("#postTextArea").val()),c=
$("#roomid").val();$("#postTextArea").val("");b&&c?(a.post(c,b,WE.boxCaht.replyId),location.reload()):$("#postText").focus();return!1})},post:function(a,b,c){$("#postTypeGroup button").attr("disabled","disabled").text("\u53d1\u9001\u4e2d...");var c=!c?void 0:c,d=new WE.api.ChatModel,e=new WE.Controller;e.update=function(a){a.data.code==0&&($("#postText").html("").focus(),$("#postTypeGroup button").removeAttr("disabled").text("\u53d1\u9001"))};d.addObserver(e);d.postChat(a,b,c)}};
