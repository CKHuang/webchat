/*! vchat.co 2014-01-01 03:06:28 */
WE.pageChat={isLoading:0,lastTime:null,replyTo:null,isPosting:0,eleId:1,postList:[],isPostInputFocus:!0,init:function(){this.ui={postBox:$("#post-box"),replayBox:$("#replay-box")},WE.pageChat.tabSelect.init(),this.regEvent()},regEvent:function(){var a=this;this.ui.postBox.find(".text-box input").keyup(function(b){if(13==b.keyCode){var c=$.trim($(this).val());""==c||a.isPosting||(a.post(ROOM.id,c,a.replyTo),a.postList.push(a.eleId),WE.pageChat.timeLine.append({eleId:"my-talk-"+a.eleId,_id:"",aim:null,del:0,from:{_id:USER._id,avatar:USER.avatar,name:USER.name,summary:USER.summary},roomid:ROOM.id,text:c,time:"...",to:"*"}),a.eleId++)}}),$("#timeline-bar").bind("scroll",function(){var b=$(this);0==a.isLoading?0==b.scrollTop()&&WE.pageChat.timeLine.leave_count>0&&(a.isLoading=1,a.getMore()):2==a.isLoading&&0==b.scrollTop()&&a.noMoreTips()}),this.ui.postBox.find(".text-box input").focus(function(){a.isPostInputFocus=!0}).blur(function(){a.isPostInputFocus=!1}),$(window).keydown(function(b){13==b.keyCode&&(a.isPostInputFocus||(a.ui.postBox.find(".text-box input").css("background","#FFF8C5"),setTimeout(function(){a.ui.postBox.find(".text-box input").css("background","none")},1500)),a.ui.postBox.find(".text-box input").focus(),a.ui.postBox.find(".text-box input").keyup())})},tipsTimeout:null,noMoreTips:function(){clearTimeout(this.tipsTimeout),$("#more-talks .tips").text("没有更多信息了..."),$("#more-talks").fadeIn(),this.tipsTimeout=setTimeout(function(){$("#more-talks").fadeOut()},2e3)},getMore:function(){$("#more-talks").fadeIn();var a=this,b=new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){var c=b.data;setTimeout(function(){0==c.code&&c.result.length?(a.isLoading=0,WE.pageChat.timeLine.leave_count=WE.pageChat.timeLine.leave_count-c.result.length,WE.pageChat.timeLine.prepends(c.result)):a.isLoading=2,$("#more-talks").fadeOut()},500)},c.error=function(){$("#more-talks").fadeOut()},b.addObserver(c),b.getMore(ROOM.id,this.lastTime)},post:function(a,b,c){var d=this;this.isPosting=!0,aim=null==c?void 0:c;var d=this,e=new WE.api.RoomModel,f=new WE.Controller;f.update=function(a){var b=a.data;0==b.code&&(d.ui.postBox.find(".text-box input").val(""),d.hideReply()),d.replyTo=null,d.isPosting=!1},e.addObserver(f),e.postChat(a,b,aim)},setReply:function(a){var b=this;this.replyTo=a._id,this.ui.replayBox.html(WE.kit.tmpl(this.replyTmpl,a)),this.ui.replayBox.removeClass("hidden"),this.ui.replayBox.find(".close-btn").click(function(){b.ui.replayBox.empty(),b.ui.replayBox.addClass("hidden")}),this.ui.postBox.find(".text-box input").focus()},hideReply:function(){this.ui.replayBox.empty(),this.ui.replayBox.addClass("hidden")},replyTmpl:'<div class="replay-box">					<div class="arrow"></div>					<span class="icon-close close-btn"></span>					<div>						<a href="/user/<%=from._id%>" target="_blank" class="name"><%=from.name == ""? "(暂无昵称)" : from.name %></a> : 					</div>					<div class="context"><%=text %></div>				</div>'},WE.pageChat.activation={init:function(){this.ui={openBtn:$("#activation-open-btn")},this.regEvent()},regEvent:function(){var a=this;this.ui.openBtn.click(function(){a.open()})},open:function(){var a=new WE.api.RoomModel,b=new WE.Controller;b.update=function(a){var b=a.data;b.result&&location.reload()},a.addObserver(b),a.setRoomOpen(ROOM.id)},close:function(){var a=new WE.api.RoomModel,b=new WE.Controller;b.update=function(a){var b=a.data;b.result&&location.reload()},a.addObserver(b),a.setRoomClose(ROOM.id)}},WE.pageChat.login={isLogin:!1,init:function(){this.ui={nickNameInput:$("#login-nickname-input"),nickNameBtn:$("#login-nickname-btn"),nickNameWall:$("#login-nickname-wall")},this.regEvent()},regEvent:function(){var a=this;this.ui.nickNameInput.keyup(function(b){var c=$.trim(a.ui.nickNameInput.val());if(""!=c?a.ui.nickNameBtn.find(".icon-go").addClass("icon-go-click"):a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click"),13==b.keyCode){var d=c;""==d||a.isLogin||(a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click"),a.nickNameLogin(d))}}),this.ui.nickNameBtn.click(function(){var b=$.trim(a.ui.nickNameInput.val());""!=b&&(a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click"),a.nickNameLogin(b))})},nickNameLogin:function(a){var b=this;b.isLogin=!0,b.ui.nickNameBtn.find(".icon-go").addClass("hidden"),b.ui.nickNameBtn.find(".icon-loading").removeClass("hidden");var c=new WE.api.UserModel,d=new WE.Controller;d.update=function(a){var c=a.data;0==c.code&&($("#wall-room").removeClass("login-style"),location.reload()),setTimeout(function(){b.isLogin=!1,b.ui.nickNameBtn.find(".icon-go").removeClass("hidden"),b.ui.nickNameBtn.find(".icon-loading").addClass("hidden")},1e3)},c.addObserver(d),c.updateUserName(a)}},WE.pageChat.timeLine={tmpl:'<div class="talk <% if( from._id == USER._id ){ %> me <% } %>" <% if( typeof obj.eleId != "undefined" ){ %> id="<%=obj.eleId %>" <% } %>>				<div class="photo">					<a href="/user/<%=from._id%>" target="_blank" data-uid="<%=from._id%>">						<img src="<%=from.avatar%>">					</a>				</div>				<div class="info">					<div class="head">						<a href="/user/<%=from._id%>" target="_blank" class="name <% if(from.name==""){ %> no-name <% } %>"><%= from.name == ""? "(暂无昵称)" : from.name %></a>						<a target="_blank" href="/d/<%=_id%>" class="time">							<% if( time == "..." ){ %>								...							<% }else{ %>								<%=WE.kit.weFormat( time*1000 ) %>							<% } %>						</a>					</div>					<% if(obj.aim){ %>					<div class="reply"><%=aim.text%></div>					<% } %>					<div class="context">						<%=WE.markdown.format(text)%><a href="javascript:;" data-mid="<%=_id%>" class="icon-reply chat-reply" title="回复"></a>					</div>				</div>			</div>',mapData:{},init:function(a,b){var c=this,d=0,e=a.length;for(c.chats_count=b,c.leave_count=b>30?b-30:0;e>d;d++)this.mapData[a[d]._id]=a[d];this.appends(a),e&&a[0].time?WE.pageChat.lastTime=a[0].time:(WE.pageChat.isLoading=2,WE.pageChat.lastTime=-1),$("#timeline-talks").delegate(".chat-reply","click",function(){var a=$(this).attr("data-mid");chat=c.mapData[a],chat&&WE.pageChat.setReply(chat)})},append:function(a){""!=this.mapData[a._id]&&(this.mapData[a._id]=a),$("#timeline-talks").append(WE.kit.tmpl(this.tmpl,a)),$("#timeline-bar").scrollTop(99999)},appends:function(a){for(var b=0,c=a.length,d="";c>b;b++)this.mapData[a[b]._id]=a[b],d+=WE.kit.tmpl(this.tmpl,a[b]);$("#timeline-talks").append(d),a[0]&&a[0].time?WE.pageChat.lastTime=a[0].time:console.log("lastTime 失败"),$("#timeline-bar").scrollTop(99999)},prepends:function(a){for(var b=0,c=a.length,d="";c>b;b++)this.mapData[a[b]._id]=a[b],d+=WE.kit.tmpl(this.tmpl,a[b]);var e=$(d);e.insertAfter($("#more-talks"));var f=0;$.each(e,function(a,b){f+=b.offsetHeight}),$("#timeline-bar").scrollTop(f-20),a[0].time?WE.pageChat.lastTime=a[0].time:console.log("lastTime 失败")},updatePost:function(a,b){this.mapData[b._id]=b;var c=$("#my-talk-"+a);c.find(".chat-reply").attr("data-mid",b._id),c.find(".time").text(WE.kit.weFormat(1e3*b.time))}},WE.pageChat.tabSelect={init:function(){this.ui={tab:$("#tab-select"),content:$("#tab-content")},this.regEvent()},regEvent:function(){var a=this;this.ui.tab.find("a").click(function(){a.ui.content.find(".tab-wall-cell").hide(),a.ui.tab.find("a").removeClass("select"),$(this).addClass("select")})}},WE.pageChat.userlist={tmpl:'<li id="uid_<%=_id%>" class="<% if( _id == USER._id){ %> me <% } %><% if( typeof obj.online != "undefined" ){ %> insert-li <% } %>" >				<a href="/user/<%=_id%>" target="_blank"  class="name <% if(name == ""){ %>no-name<% } %>" >					<img src="<%=avatar%>"><%= name == ""? "(暂无昵称)" : name%>				</a>			</li>',data:null,init:function(a){var b=a.length-1,c="";if(a){for(this.data=a,c+=WE.kit.tmpl(this.tmpl,USER);b>=0;b--)this.data[b]._id!=USER._id&&(c+=WE.kit.tmpl(this.tmpl,a[b]));$("#user-list").empty().html(c)}this.ui={onlineBtn:$("#online-btn"),content:$("#online")},this.regEvent()},regEvent:function(){var a=this;this.ui.onlineBtn.click(function(){a.ui.content.show()})},append:function(a){if(a._id!=USER._id){this.data?this.data.push(a):this.data=[a],a.online=!0;var b=WE.kit.tmpl(this.tmpl,a);setTimeout(function(){$("#uid_"+a._id).removeClass("insert-li")},300),$("#user-list li").eq(0).after(b)}},remove:function(a){var b=this.data;$("#uid_"+a._id).remove();for(var c=0;c<b.length;c++)if(b[c]._id==a._id){b.splice(c,1);break}}},WE.pageChat.historylist={isLoadData:!1,tmpl:'<li>			    <a href="/user/<%=_id%>" target="_blank" title="<%=name%>">					<img src="<%=avatar%>">				</a>		    </li>',init:function(){this.ui={wall:$("#history"),list:$("#history-list"),activeBtn:$("#history-btn")},this.regEvent()},regEvent:function(){var a=this;this.ui.activeBtn.click(function(){a.displayHistory()})},displayHistory:function(){var a=this;if(!this.isLoadData){var b=new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){var c=b.data,d="";if(0==c.code){a.isLoadData=!0;for(var e=0;e<c.result.length;e++)d+=WE.kit.tmpl(a.tmpl,c.result[e]);a.ui.list.empty().html(d)}},b.addObserver(c),b.historyList(ROOM.id)}this.ui.wall.show()}},WE.pageChat.invite={selectList:{mail:[],user:[]},datas:[],isGetData:!1,isSending:!1,mailInputList:[],init:function(){var a=$("#invite");this.ui={wall:$("#wall-room"),inviteWall:a,boot:$("#invite-btn"),close:a.find(".js-close-btn"),usersList:$("#users-list"),emailInput:a.find(".email-input"),emailTips:a.find(".email-input .error-tips"),submit:$("#invite-submit")},this.regEvent()},regEvent:function(){var a=this;this.ui.boot.click(function(){a.ui.wall.addClass("invite-style"),a.ui.close.find("i").addClass("animate"),a.isGetData?a.addUsers(a.datas):a.getUserList()}),this.ui.close.click(function(){a.ui.wall.removeClass("invite-style"),a.ui.usersList.empty(),a.ui.emailInput.find("input").val(""),a.selectList.mail=[],a.selectList.user=[],a.ui.close.removeClass("animate")}),this.ui.usersList.find(".cell").click(function(){var a=$(this),b=(a.index(),a.hasClass("select-cell"));b?a.removeClass("select-cell"):a.addClass("select-cell"),b?a.find(".select").addClass("hidden"):a.find(".select").removeClass("hidden"),b?a.find(".invite").show():a.find(".invite").hide()}),this.ui.emailInput.find("input").keyup(function(b){var c=$.trim(a.ui.emailInput.find("input").val());if(13==b.keyCode&&""!=c){if(!/^[^@]+@[^@]+$/.test(c))return a.ui.emailTips.text("Please input email").show(),setTimeout(function(){a.ui.emailTips.hide()},2e3),!1;for(var d=a.selectList.mail.length,e=a.selectList.mail,f=!1,g=0;d>g;g++)if(e[g].mail==c){f=!0,a.ui.emailTips.text("邮箱已经存在").show(),setTimeout(function(){a.ui.emailTips.hide()},2e3);break}f||a.addUser({mail:c},!0),a.ui.emailInput.find("input").val("")}}),this.ui.emailInput.find("input").focus(function(){a.ui.emailTips.hide()}),this.ui.submit.click(function(){(a.selectList.mail.length||a.selectList.user.length)&&(a.isSending||a.invitePost())})},addUser:function(a,b){var c=new WE.pageChat.inviteCell(a,b);c.prepend(this.ui.usersList)},addUsers:function(a){for(var b=a.length,c=0;b>c;c++)this.addUser(a[c].to,!1)},getUserList:function(){var a=this,b=new WE.api.UserModel,c=new WE.Controller;c.update=function(b){var c=b.data;0==c.code&&(a.isGetData=!0,a.datas=c.result,a.addUsers(a.datas))},b.addObserver(c),b.getContactList()},invitePost:function(){var a=this;this.isSending=!0,this.ui.submit.text("发送中...");var b=new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){a.isSending=!1,a.ui.submit.text("发送邀请"),a.ui.emailInput.find("input").val(""),a.selectList.user=[],a.selectList.mail=[];var c=b.data;0==c.code?a.ui.emailInput.find(".invite-tips").text("已经成功发送邀请").show():a.ui.emailInput.find(".invite-tips").text("发送邀请失败").show(),a.ui.usersList.empty(),setTimeout(function(){a.ui.emailInput.find(".invite-tips").hide(),a.addUsers(a.datas)},3e3)},b.addObserver(c),b.inviteChat(a.selectList.user,a.selectList.mail,ROOM.id)}},WE.pageChat.inviteCell=function(a,b){this.data=a,this.select=b||!1,this.isUserList="undefined"!=typeof a.name?!0:!1,this.list=this.isUserList?WE.pageChat.invite.selectList.user:WE.pageChat.invite.selectList.mail,this.listIndex=this.list.length;var c=WE.kit.tmpl(this.itemTmpl,{user:this.data,select:b});wall=$(c),this.ui={wall:wall,invite:wall.find(".invite-js-btn"),cell:wall.find(".cell")},this.select&&this.addUser(),this.init()},WE.pageChat.inviteCell.prototype={itemTmpl:'<li>				<div class="cell <% if( select ){ %> select-cell <% } %>">					<% if( typeof user.avatar != "undefined" ){ %>					<img src="<%=user.avatar %>">					<% } %>					<% if( typeof user.name != "undefined" && user.name == "" ){ %>						<% user.name = "(未设置昵称的小伙伴)"; %>					<% } %>					<%=user.name || user.mail %>					<% if( select ){ %>						<div class="invite-js-btn">							<span class="select select-type">√</span>							<span class="btn invite-type invite" style="display:none;">邀请</span>						</div>					<% }else{ %>						<div class="invite-js-btn">							<span class="select select-type hidden">√</span>							<span class="btn invite-type invite">邀请</span>						</div>					<% } %>				</div>			</li>',init:function(){this.regEvent()},regEvent:function(){var a=this;this.ui.cell.click(function(){a.select=1==a.select?!1:!0,a.select?(a.ui.invite.find(".select-type").removeClass("hidden"),a.ui.invite.find(".invite-type").hide(),a.ui.cell.addClass("select-cell"),a.addUser()):(a.ui.invite.find(".select-type").addClass("hidden"),a.ui.invite.find(".invite-type").show(),a.ui.cell.removeClass("select-cell"),a.removeUser())})},prepend:function(a){a.prepend(this.ui.wall)},addUser:function(){this.isUserList?this.list.push(this.data._id):this.list.push(this.data.mail)},removeUser:function(){for(var a=this.list.length,b=0;a>b;b++)this.isUserList?this.data._id&&this.data._id==this.list[b]&&this.list.splice(b,1):this.data.mail&&this.data.mail==this.list[b]&&this.list.splice(b,1)}},WE.pageChat.roomEdit={isEditType:!1,init:function(){this.ui={boot:$("#room-edit-boot"),box:$("#room-edit-box"),titleBox:$("#title-box"),checkpwd:$("#checkpwd"),password:$("#password"),topic:$("#topic-name"),form:$("#room-edit-form")},this.regEvent()},regEvent:function(){var a=this;this.ui.boot.click(function(){a.isEditType?(a.isEditType=!1,a.ui.boot.text("编辑"),a.ui.box.find(".close-btn").click()):(a.isEditType=!0,a.ui.boot.text("取消"),a.clear(),a.ui.titleBox.height("100%"),a.ui.topic.focus(),a.ui.box.show())}),this.ui.box.find(".close-btn").click(function(){a.ui.titleBox.height("auto"),a.ui.box.hide()}),this.ui.box.find(".topic-edit-submit").click(function(){var b=$.trim(a.ui.topic.val()),c=$.trim(a.ui.password.val());return""!=b?(a.post(ROOM.id,b,c),!1):void 0}),this.ui.checkpwd.change(function(){var b=a.ui.checkpwd.is(":checked");return b?(a.ui.password.show(),void 0):(a.ui.password.hide(),a.ui.password.val(""),!1)})},post:function(a,b,c){var d=new WE.api.RoomModel,e=new WE.Controller;e.update=function(a){var b=a.data;0==b.code&&location.reload()},d.addObserver(e),d.updateRoomBase(a,b,c)},clear:function(){null==ROOM.password?this.ui.password.hide():this.ui.password.show(),null!=ROOM.password?this.ui.checkpwd.attr("checked","checked"):this.ui.checkpwd.removeAttr("checked"),this.ui.password.val(null==ROOM.password?"":ROOM.password),this.ui.topic.val(ROOM.topic)}},WE.pageChat.videoChat={init:function(){this.ui={boot:$("#video-chat"),roomWall:$("#wall-room"),videoWall:$("#video-wall")},this.regEvent()},regEvent:function(){var a=this;this.ui.boot.click(function(){a.boot(),a.setOnVideoBoot()})},boot:function(){var a=this;this.ui.roomWall.addClass("video-style"),this.ui.videoWall.show();var b=new WE.pageChat.VideoModule("video-wall");b.onClose=function(){a.ui.roomWall.removeClass("video-style"),a.setOffVideoBoot(),a.ui.videoWall.hide()}},setOnVideoBoot:function(){this.ui.boot.find("i").addClass("video-active").attr("title","视频已经开启")},setOffVideoBoot:function(){this.ui.boot.find("i").removeClass("video-active").attr("title","点击开启视频聊天")}},WE.pageChat.VideoModule=function(a){var b=this;this.parentId=a,WE.kit.getTmpl("video-chat.ejs",function(a){var c=$(a);b.ui={wall:c,close:c.find(".js-close"),view:c.find(".js-view"),list:c.find(".js-list")},b.setList(),b.html(b.parentId),b.regEvent()})},WE.pageChat.VideoModule.prototype={itemTmpl:'<div class="item <% if( typeof isMe != "undefined" ){ %> item-me <% } %>">					<video></video>					<div class="tabs">						<i class="arrow"></i>						<a class="name" target="_blank" title="CK.Ming" href="http://www.baidu.com">( Me )</a>						<% if( typeof isMe != "undefined" ){ %>							<span class="js-mike mike">								<i class="icon-onmike"></i>							</span>						<% }else{ %>							<span class="js-sound sound">								<i class="icon-onsound"></i>							</span>						<% } %>					</div>				</div>',regEvent:function(){var a=this;a.ui.close.click(function(){a.close()})},close:function(){this.ui.wall.remove(),this.onClose()},onClose:function(){},html:function(a){$("#"+a).html(this.ui.wall)},setList:function(){var a="";a+=WE.kit.tmpl(this.itemTmpl,{isMe:!0});for(var b=0;3>b;b++)a+=WE.kit.tmpl(this.itemTmpl,{});this.ui.list.html(a)}};