WE.top={init:function(){var a=$("#search-box");this.ui={box:a,input:a.find(".search-input"),resultBox:a.find(".result-box"),results:a.find(".results"),loading:a.find(".loading"),searchForm:$("#search-form")};this.regEvent()},value:null,isSearch:!1,inputGrap:null,regEvent:function(){var a=this;a.ui.input.keyup(function(b){if(38==b.keyCode||40==b.keyCode)return!1;if(13==b.keyCode&&null!=a.datas&&-1!=a.index)return window.location.href="/t/"+(a.datas[a.index].name||a.datas[a.index].id),!1;if(13==b.keyCode)return a.ui.searchForm.submit(),
!1;var c=$.trim(a.ui.input.val());a.ui.results.html("");a.ui.results.append(WE.kit.tmpl(a.searchTmpl,{key:c}));clearTimeout(a.inputGrap);""!=c?(a.ui.resultBox.removeClass("hidden"),a.ui.loading.show(),a.value=c,a.inputGrap=setTimeout(function(){a.search(c)},350)):""==c&&a.ui.resultBox.addClass("hidden")});a.ui.input.keydown(function(b){var c=b.keyCode;if(38==c||40==c)b.preventDefault(),a.select(38==c?-1:1)});a.ui.input.blur(function(b){setTimeout(function(){a.ui.resultBox.addClass("hidden")},250)})},
search:function(a){var b=this;b.isSearch=!0;var c=new WE.api.RoomModel,d=new WE.Controller;d.update=function(c){c=c.data;0==c.code&&(b.setResult(a,c.result),b.isSearch=!1)};d.error=function(){b.isSearch=!1};c.addObserver(d);c.search(a)},resultTmpl:'<a href="/t/<%=name || id %>"><i class="icon-chat"></i><%=topic %></a>',searchTmpl:'<a class="key" href="/search?key=<%=key %>">Search Topics for "<%=key %>"</a>',setResult:function(a,b){var c="",d=b.length;if(0<b.length)for(var e=0;e<d;e++)c+=WE.kit.tmpl(this.resultTmpl,
b[e]);c+=WE.kit.tmpl(this.searchTmpl,{key:a});this.ui.loading.hide();this.ui.results.empty();this.ui.results.html(c);this.index=-1;this.maxIndex=d+1;this.datas=b},index:-1,maxIndex:0,datas:null,select:function(a){var b=this.index,c=this.maxIndex,d=this.ui.results.find("a");d.eq(-1==b?c-1:b).removeClass("select");b+=a;b=b>c?0:b;b=0>b?c:b;-1!=b&&d.eq(b).addClass("select");-1!=b&&this.ui.input.val(""==d.eq(b).text()?this.value:d.eq(b).text());this.index=b}};
