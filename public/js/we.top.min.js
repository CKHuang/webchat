WE.top={};WE.top.init=function(){WE.top.search.init();WE.top.notice.init()};
WE.top.search={init:function(){var b=$("#search-box");this.ui={box:b,input:b.find(".search-input"),resultBox:b.find(".result-box"),results:b.find(".results"),loading:b.find(".loading"),searchForm:$("#search-form")};this.regEvent()},value:null,isSearch:!1,inputGrap:null,regEvent:function(){var b=this;b.ui.input.keyup(function(a){if(38==a.keyCode||40==a.keyCode)return!1;if(13==a.keyCode)return window.location.href=null!=b.datas&&-1!=b.index&&b.index!=b.maxIndex-1?"/t/"+(b.datas[b.index].name||b.datas[b.index].id):
"/search?key="+b.value,a.preventDefault(),a.stopPropagation(),!1;var c=$.trim(b.ui.input.val());b.ui.results.html("");b.ui.results.append(WE.kit.tmpl(b.searchTmpl,{key:c}));clearTimeout(b.inputGrap);""!=c?(b.ui.resultBox.removeClass("hidden"),b.ui.loading.show(),b.value=c,b.inputGrap=setTimeout(function(){b.search(c)},350)):""==c&&b.ui.resultBox.addClass("hidden")});b.ui.input.keydown(function(a){var c=a.keyCode;13==c&&a.preventDefault();if(38==c||40==c)a.preventDefault(),b.select(38==c?-1:1)});b.ui.input.blur(function(a){b.ui.resultBox.addClass("hidden")});
b.ui.resultBox.mousedown(function(a){b.ui.resultBox.removeClass("hidden");a.stopPropagation();return!1});b.ui.results.keydown(function(a){b.ui.resultBox.removeClass("hidden");a.stopPropagation();return!1})},search:function(b){var a=this;a.isSearch=!0;var c=new WE.api.RoomModel,d=new WE.Controller;d.update=function(c){c=c.data;0==c.code&&(a.setResult(b,c.result),a.isSearch=!1)};d.error=function(){a.isSearch=!1};c.addObserver(d);c.search(b)},resultTmpl:'<a href="/t/<%=name || id %>"><i class="icon-chat"></i><%=topic %></a>',
searchTmpl:'<a class="key" href="/search?key=<%=encodeURIComponent(key) %>">Search Topics for "<%=encodeURIComponent(key) %>"</a>',setResult:function(b,a){var c="",d=a.length;if(0<a.length)for(var e=0;e<d;e++)c+=WE.kit.tmpl(this.resultTmpl,a[e]);c+=WE.kit.tmpl(this.searchTmpl,{key:b});this.ui.loading.hide();this.ui.results.empty().addClass("hidden");this.ui.results.html(c);this.index=-1;this.maxIndex=d+1;this.datas=a;this.ui.results.removeClass("hidden")},index:-1,maxIndex:0,datas:null,select:function(b){var a=
this.index,c=this.maxIndex,d=this.ui.results.find("a");d.eq(-1==a?c-1:a).removeClass("select");a+=b;a=a>c?0:a;a=0>a?c:a;-1!=a&&d.eq(a).addClass("select");-1!=a&&this.ui.input.val(""==d.eq(a).text()?this.value:d.eq(a).text());this.index=a}};
WE.top.notice={noticeTmpl:'<li>\t\t\t\t\t<a href="/user/<%=from._id %>"><%=from.name %></a> \u5728 <a href="/d/<%=response %>"><%=where.topic %></a> \u56de\u590d\u4e86\u4f60\t\t\t\t\t<span class="know" data-nid="<%=_id %>">\u4e0d\u518d\u63d0\u9192</span>\t\t\t\t</li>',noResultTmpl:'<p class="no-notice">No recent new notice...</p>',init:function(){var b=$("#notice-box");this.ui={wall:b,bell:b.find(".bell"),list:b.find(".notice-list")};this.getStatus();this.regEvent()},regEvent:function(){var b=this;
this.ui.bell.click(function(a){b.setBellStatus(0);b.getNotices();b.ui.list.removeClass("hidden");a.preventDefault()})},getStatus:function(){var b=this,a=new WE.api.NoticeModel,c=new WE.Controller;c.update=function(a){a=a.data;0==a.code&&0<a.result&&b.setBellStatus(1)};a.addObserver(c);a.noticeCount()},setBellStatus:function(b){b?this.ui.bell.find("i").removeClass("icon-noticedefault").addClass("icon-noticeaction"):this.ui.bell.find("i").removeClass("icon-noticeaction").addClass("icon-noticedefault")},
appends:function(b){for(var a=b.length,c=0,d='<ul class="notices">';c<a;c++)d+=WE.kit.tmpl(this.noticeTmpl,b[c]);d+="</ul>";this.ui.list.find(".content").empty().append(d)},setNoResult:function(){this.ui.list.find(".content").empty().append(this.noResultTmpl)},getNotices:function(){var b=this,a=new WE.api.NoticeModel,c=new WE.Controller;c.update=function(a){a=a.data;0==a.code&&(a.result.count?b.appends(a.result.list):b.setNoResult())};a.addObserver(c);a.noticeList()}};
