WE.api=WE.api||{};WE.api.TopModel=function(){this.historyChatsUrl="/sys/ichats"};WE.api.TopModel.prototype=WE.BaseModel.prototype;WE.api.TopModel.prototype.historyChats=function(){this.get(this.historyChatsUrl)};WE.api=WE.api||{};WE.api.NoticeModel=function(){this.noticeCountUrl="/sys/notice_count";this.noticeListUrl="/sys/notice_list"};WE.api.NoticeModel.prototype=WE.BaseModel.prototype;WE.api.NoticeModel.prototype.noticeCount=function(){this.get(this.noticeCountUrl)};WE.api.NoticeModel.prototype.noticeList=function(){this.get(this.noticeListUrl)};WE.api.NoticeModel.prototype.noticeStatus=function(a){this.post(this.noticeStatusUrl,{_id:a})};WE.pageTop={setUserName:function(a){var c=new WE.Dialog({title:"\u4fee\u6539\u6635\u79f0",id:"setUserName",width:400,height:200});c.onclose=function(){console.log("What")};c.show();WE.kit.getTmpl("update_user_name.ejs",function(b){b=WE.kit.tmpl(b,a);c.append(b);$("#setUserNameForm").submit(function(){var a=$("#newUserName"),b=a.val();if(b){$("#setUserNameForm input[type=submit]").attr("disabled","disabled").val("\u63d0\u4ea4\u4e2d...");var a=new WE.api.ChatModel,d=new WE.Controller;d.update=function(a){a=
a.data;$("#setUserNameForm input[type=submit]").removeAttr("disabled").val("\u63d0\u4ea4");a.code==0?(c.close(),setTimeout(function(){document.location.reload()},500)):alert(a.msg)};a.addObserver(d);a.updateUserName(b)}else a.focus();return!1});$("#anonymous").click(function(){$("#newUserName").val("\u533f\u540d");$("#setUserNameForm").submit()})})},bindEmail:function(){function a(a,e){$("#bindMialForm input[type=submit]").attr("disabled","disabled").val("\u63d0\u4ea4\u4e2d...");var f=new WE.api.ChatModel,
d=new WE.Controller;d.update=function(a){a=a.data;$("#bindMialForm input[type=submit]").removeAttr("disabled").val("\u63d0\u4ea4");a.code==0?(c.close(),setTimeout(function(){document.location.reload()},600)):alert(a.msg)};f.addObserver(d);f.updateMailPwd(a,e)}var c=new WE.Dialog({title:"\u8bbe\u7f6email",id:"setMail",width:400,height:200});c.show();WE.kit.getTmpl("bind_mail.ejs",function(b){c.append(b);$("#bindMialForm").submit(function(){var b=$.trim($("#updateMail").val()),c=$.trim($("#updatePwd").val());
/^[\w._\-]+@[\w_\-]+\.\w+$/.test(b)?c.length>5?a(b,c):alert("\u5bc6\u7801\u957f\u5ea6\u81f3\u5c116\u4f4d"):alert("mail, \u683c\u5f0f\u4e0d\u6b63\u786e");return!1})})},getHistory:function(){var a=new WE.Dialog({title:"\u53c2\u4e0e\u8fc7\u7684\u5bf9\u8bdd",id:"getHistory",width:200,height:200});a.show();WE.kit.getTmpl("history_chat.ejs",function(c){var b=new WE.api.TopModel,e=new WE.Controller;e.update=function(b){b=b.data;b.code==0&&(b=WE.kit.tmpl(c,b.result),a.append(b))};b.addObserver(e);b.historyChats()})}};
WE.pageTop.notice={init:function(){var a=$("#notice-box");this.ui={box:a,circle:a.find(".circle"),list:a.find(".notice-list"),title:a.find(".notice-title"),content:a.find(".notice-content")};this.setNoticeCount();this.regEvent()},regEvent:function(){var a=this;a.ui.title.click(function(){a.getNoticeList()})},noticeItemTmpl:'<% for(var i=0;i < obj.length;i++ ){ %>\t\t\t\t\t  <li>\t\t\t\t\t\t<span><%=obj[i].from.name%></span>\u5728<a data-mid="<%=obj[i]._id%>" class="notice-item" href="#"><%=obj[i].where.topic%></a>\u56de\u590d\u4e86\u4f60\t\t\t\t\t  </li>\t\t\t\t\t  <% } %>',
noNoticeTmpl:"<p>\u6700\u8fd1\u6ca1\u6709\u6536\u5230\u65b0\u63d0\u9192...</p>",setNoticeCount:function(){var a=this,c=new WE.api.NoticeModel,b=new WE.Controller;b.update=function(b){b.data.result&&a.ui.circle.show()};c.addObserver(b);c.noticeCount()},getNoticeList:function(){var a=this,c=new WE.api.NoticeModel,b=new WE.Controller;b.update=function(b){b=b.data;b.result.length&&(b=WE.tmpl(a.noticeItemTmpl,b),$(b).appendTo(a.ui.list),a.ui.list.delegate(".notice-item","click",function(){var b=$(this).data("mid");
a.setNoticeStatus(b)}))};c.addObserver(b);c.noticeList()},setNoticeStatus:function(a){var c=new WE.api.NoticeModel,b=new WE.Controller;b.update=function(){};c.addObserver(b);c.noticeStatus(a)}};WE.pageTop.init=function(){var a=this;$("#username").click(function(){a.setUserName(USER)});$("#bindmail").click(function(){a.bindEmail()});$("#chatme").click(function(){a.getHistory()});a.notice.init()};$(document).ready(function(){WE.pageTop.init()});
