/*! vchat.co 2014-01-01 03:06:28 */
WE.top={},WE.top.init=function(){WE.top.search.init(),WE.top.notice.init(),WE.top.msgNotice.init()},WE.top.search={init:function(){var a=$("#search-box");this.ui={box:a,input:a.find(".search-input"),resultBox:a.find(".result-box"),results:a.find(".results"),loading:a.find(".loading"),searchForm:$("#search-form")},this.regEvent()},value:null,isSearch:!1,inputGrap:null,regEvent:function(){var a=this;a.ui.input.keyup(function(b){if(38==b.keyCode||40==b.keyCode)return!1;if(13==b.keyCode)return window.location.href=null!=a.datas&&-1!=a.index&&a.index!=a.maxIndex-1?"/t/"+(a.datas[a.index].name||a.datas[a.index].id):"/search?key="+a.value,b.preventDefault(),b.stopPropagation(),!1;var c=$.trim(a.ui.input.val());a.ui.results.html(""),a.ui.results.append(WE.kit.tmpl(a.searchTmpl,{key:c})),clearTimeout(a.inputGrap),""!=c?(a.ui.resultBox.removeClass("hidden"),a.ui.loading.show(),a.value=c,a.inputGrap=setTimeout(function(){a.search(c)},350)):""==c&&a.ui.resultBox.addClass("hidden")}),a.ui.input.keydown(function(b){var c=b.keyCode;13==c&&b.preventDefault(),(38==c||40==c)&&(b.preventDefault(),a.select(38==c?-1:1))}),a.ui.input.blur(function(){a.ui.resultBox.addClass("hidden")}),a.ui.resultBox.mousedown(function(b){return a.ui.resultBox.removeClass("hidden"),b.stopPropagation(),!1}),a.ui.results.keydown(function(b){return a.ui.resultBox.removeClass("hidden"),b.stopPropagation(),!1})},search:function(a){var b=this;b.isSearch=!0;var c=new WE.api.RoomModel,d=new WE.Controller;d.update=function(c){var d=c.data;0==d.code&&(b.setResult(a,d.result),b.isSearch=!1)},d.error=function(){b.isSearch=!1},c.addObserver(d),c.search(a)},resultTmpl:'<a href="/t/<%=name || id %>"><i class="icon-chat"></i><%=topic %></a>',searchTmpl:'<a class="key" href="/search?key=<%=encodeURIComponent(key) %>">Search Topics for "<%=key.replace(/</g,"&lt;").replace(/>/g,"&gt;") %>"</a>',setResult:function(a,b){var c="",d=b.length;if(b.length>0)for(var e=0;d>e;e++)c+=WE.kit.tmpl(this.resultTmpl,b[e]);c+=WE.kit.tmpl(this.searchTmpl,{key:a}),this.ui.loading.hide(),this.ui.results.empty().addClass("hidden"),this.ui.results.html(c),this.index=-1,this.maxIndex=d+1,this.datas=b,this.ui.results.removeClass("hidden")},index:-1,maxIndex:0,datas:null,select:function(a){var b=this.index,c=this.maxIndex,d=this.ui.results.find("a");d.eq(-1==b?c-1:b).removeClass("select"),b+=a,b=b>c?0:b,b=0>b?c:b,-1!=b&&d.eq(b).addClass("select"),-1!=b&&this.ui.input.val(""==d.eq(b).text()?this.value:d.eq(b).text()),this.index=b}},WE.top.notice={hasNotices:!1,noticeTmpl:'<li>					<a href="/user/<%=from._id %>"><%=from.name %></a> 在 <a href="/d/<%=response %>?noticeid=<%=_id %>"><%=where.topic %></a> 回复了你					<span class="know" data-nid="<%=_id %>">不再提醒</span>				</li>',noResultTmpl:'<p class="no-notice">没有最新的通知...</p>',init:function(){var a=$("#notice-box");this.ui={wall:a,bell:a.find(".bell"),list:a.find(".notice-list")},this.getStatus(),this.regEvent()},pollPoint:null,poll:function(){},regEvent:function(){var a=this;$("body").click(function(){a.ui.list.hide()}),this.ui.wall.click(function(b){b.stopPropagation(),a.ui.list.show()}),this.ui.bell.click(function(b){clearInterval(a.pollPoint),a.hasNotices=!1,a.setBellStatus(0),a.getNotices(),a.ui.list.removeClass("hidden"),b.preventDefault()}),this.ui.list.delegate(".know","click",function(){var b=$(this),c=b.attr("data-nid"),d=new WE.api.NoticeModel,e=new WE.Controller;e.update=function(c){var d=c.data;0==d.code&&(b.animate({height:"0px"},800,function(){b.remove()}),a.getNotices())},d.addObserver(e),d.noticeStatus(c)})},getStatus:function(){var a=this,b=new WE.api.NoticeModel,c=new WE.Controller;c.update=function(b){var c=b.data;if(0==c.code){if(0==c.result)return a.hasNotices=!1,!1;a.hasNotices=!0,a.setBellStatus(1)}},b.addObserver(c),b.noticeCount()},setBellStatus:function(a){a?this.ui.bell.find("i").removeClass("icon-noticedefault").addClass("icon-noticeaction"):this.ui.bell.find("i").removeClass("icon-noticeaction").addClass("icon-noticedefault")},appends:function(a){for(var b=a.length,c=0,d='<ul class="notices">';b>c;c++)d+=WE.kit.tmpl(this.noticeTmpl,a[c]);d+="</ul>",this.ui.list.find(".content").empty().append(d)},setNoResult:function(){this.ui.list.find(".content").empty().append(this.noResultTmpl)},getNotices:function(){var a=this,b=new WE.api.NoticeModel,c=new WE.Controller;c.update=function(b){var c=b.data;0==c.code&&(c.result.count?a.appends(c.result.list):a.setNoResult())},b.addObserver(c),b.noticeList()}},WE.top.msgNotice={isSound:!1,isWindowFocus:!0,pointer:null,init:function(){this.ui={boot:$("#notice-sound"),iconBoot:$("#notice-sound").find(".js-boot")},this.isSoundCookie=window.localStorage?localStorage.getItem("noticeSound"):WE.cookie.getCookie("noticeSound"),"1"==this.isSoundCookie&&(this.ui.iconBoot.removeClass("icon-offnoticesound").addClass("icon-onnoticesound"),this.isSound=!0),this.ui.boot.find(".js-loading").remove(),this.ui.iconBoot.removeClass("hidden"),this.sound=document.createElement("audio"),this.sound.src="/msg.mp3",this.regEvent(),this.defaultTitle=document.title},regEvent:function(){var a=this;this.ui.boot.click(function(){a.isSound=a.isSound?!1:!0,window.localStorage?a.isSound?localStorage.setItem("noticeSound","1"):localStorage.setItem("noticeSound","0"):a.isSound?WE.cookie.setCookie("noticeSound","1"):WE.cookie.setCookie("noticeSound","0"),a.setBootUi(a.isSound)}),$(window).click(function(){a.isWindowFocus=!0,document.title=a.defaultTitle,clearInterval(a.pointer)}),$(window).blur(function(){a.isWindowFocus=!1})},setBootUi:function(a){this.ui.iconBoot.removeClass("icon-onnoticesound").addClass("icon-offnoticesound").attr("title","点击开启新消息声音提示"),a&&this.ui.iconBoot.removeClass("icon-offnoticesound").addClass("icon-onnoticesound").attr("title","点击关闭新消息声音提示")},onTitleNotice:function(a,b){var c=this;c.noticeTitle=a,clearInterval(this.pointer),c.isWindowFocus||(c.isSound&&1==b&&this.onSound(),this.pointer=setInterval(function(){document.title=document.title==c.noticeTitle?c.defaultTitle:c.noticeTitle},1e3))},onSound:function(){this.sound.currentTime=0,this.sound.play()}};