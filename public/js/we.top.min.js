WE.api=WE.api||{};WE.api.TopModel=function(){this.historyChatsUrl="/sys/ichats"};WE.api.TopModel.prototype=WE.BaseModel.prototype;WE.api.TopModel.prototype.historyChats=function(){this.get(this.historyChatsUrl)};WE.api=WE.api||{};WE.api.NoticeModel=function(){this.noticeCountUrl="/sys/notice_count";this.noticeListUrl="/sys/notice_list";this.noticeStatusUrl="/sys/notice_status"};WE.api.NoticeModel.prototype=WE.BaseModel.prototype;WE.api.NoticeModel.prototype.noticeCount=function(){this.get(this.noticeCountUrl)};WE.api.NoticeModel.prototype.noticeList=function(){this.get(this.noticeListUrl)};WE.api.NoticeModel.prototype.noticeStatus=function(a){this.post(this.noticeStatusUrl,{_id:a})};WE.pageTop={setUserName:function(a){var b=new WE.Dialog({title:"\u4fee\u6539\u6635\u79f0",id:"setUserName",width:400,height:200});b.onclose=function(){console.log("What")};b.show();WE.kit.getTmpl("update_user_name.ejs",function(c){c=WE.kit.tmpl(c,a);b.append(c);$("#setUserNameForm").submit(function(){var a=$("#newUserName"),d=a.val();if(d){$("#setUserNameForm input[type=submit]").attr("disabled","disabled").val("\u63d0\u4ea4\u4e2d...");var a=new WE.api.ChatModel,c=new WE.Controller;c.update=function(a){a=
a.data;$("#setUserNameForm input[type=submit]").removeAttr("disabled").val("\u63d0\u4ea4");a.code==0?(b.close(),setTimeout(function(){document.location.reload()},500)):alert(a.msg)};a.addObserver(c);a.updateUserName(d)}else a.focus();return!1});$("#anonymous").click(function(){$("#newUserName").val("\u533f\u540d");$("#setUserNameForm").submit()})})},bindEmail:function(){function a(a,e){$("#bindMialForm input[type=submit]").attr("disabled","disabled").val("\u63d0\u4ea4\u4e2d...");var d=new WE.api.ChatModel,
f=new WE.Controller;f.update=function(a){a=a.data;$("#bindMialForm input[type=submit]").removeAttr("disabled").val("\u63d0\u4ea4");a.code==0?(b.close(),setTimeout(function(){document.location.reload()},600)):alert(a.msg)};d.addObserver(f);d.updateMailPwd(a,e)}var b=new WE.Dialog({title:"\u8bbe\u7f6email",id:"setMail",width:400,height:200});b.show();WE.kit.getTmpl("bind_mail.ejs",function(c){b.append(c);$("#bindMialForm").submit(function(){var b=$.trim($("#updateMail").val()),d=$.trim($("#updatePwd").val());
/^[\w._\-]+@[\w_\-]+\.\w+$/.test(b)?d.length>5?a(b,d):alert("\u5bc6\u7801\u957f\u5ea6\u81f3\u5c116\u4f4d"):alert("mail, \u683c\u5f0f\u4e0d\u6b63\u786e");return!1})})},getHistory:function(){var a=new WE.Dialog({title:"\u53c2\u4e0e\u8fc7\u7684\u5bf9\u8bdd",id:"getHistory",width:200,height:200});a.show();WE.kit.getTmpl("history_chat.ejs",function(b){var c=new WE.api.TopModel,e=new WE.Controller;e.update=function(d){d=d.data;d.code==0&&(d=WE.kit.tmpl(b,d.result),a.append(d))};c.addObserver(e);c.historyChats()})}};
WE.pageTop.notice={isLoadCount:!1,isShowContent:!1,init:function(){var a=$("#notice-box");this.ui={box:a,circle:a.find(".circle"),list:a.find(".notice-list"),title:a.find(".notice-title"),content:a.find(".notice-content"),loading:a.find(".we-loading")};this.setNoticeCount();this.regEvent()},regEvent:function(){var a=this;a.ui.title.click(function(){a.isShowContent?(a.ui.content.hide(),a.isShowContent=!1):(a.isShowContent=!0,a.isLoadCount?a.ui.content.show():(a.ui.content.show(),a.getNoticeList()))});
$("body").click(function(){a.isShowContent=!1;a.ui.content.hide()});a.ui.box.click(function(a){a.stopPropagation()})},noticeItemTmpl:'<li>\t\t\t\t\t\t<span><%= obj.from.name %></span>\u5728<a target="_blank" data-mid="<%= obj._id %>" class="notice-item" href="/d/<%= obj.what %>"><%= obj.where.topic %></a>\u56de\u590d\u4e86\u4f60\t\t\t\t\t  </li>',noNoticeTmpl:"<p>\u6700\u8fd1\u6ca1\u6709\u6536\u5230\u65b0\u63d0\u9192...</p>",setNoticeCount:function(){var a=this,b=new WE.api.NoticeModel,c=new WE.Controller;
c.update=function(b){b.data.result&&a.ui.circle.show()};b.addObserver(c);b.noticeCount()},getNoticeList:function(){var a=this,b=new WE.api.NoticeModel,c=new WE.Controller;c.update=function(b){a.isLoadCount=!0;b=b.data;if(b.code===0&&b.result.length){for(var d="<ul>",c=0;c<b.result.length;c++)d+=WE.kit.tmpl(a.noticeItemTmpl,b.result[c]);d+="</ul>";a.ui.loading.remove();$(d).appendTo(a.ui.list)}else a.ui.content.html(b.msg)};b.addObserver(c);b.noticeList()}};
WE.pageTop.init=function(){var a=this;$("#username").click(function(){a.setUserName(USER)});$("#bindmail").click(function(){a.bindEmail()});$("#chatme").click(function(){a.getHistory()});a.notice.init()};$(document).ready(function(){WE.pageTop.init()});
