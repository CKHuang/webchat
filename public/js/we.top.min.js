WE.api=WE.api||{};WE.api.TopModel=function(){this.historyChatsUrl="/sys/ichats"};WE.api.TopModel.prototype=WE.BaseModel.prototype;WE.api.TopModel.prototype.historyChats=function(){this.get(this.historyChatsUrl)};WE.api=WE.api||{};WE.api.NoticeModel=function(){this.noticeCountUrl="/sys/notice_count";this.noticeListUrl="/sys/notice_list";this.noticeStatusUrl="/sys/notice_status"};WE.api.NoticeModel.prototype=WE.BaseModel.prototype;WE.api.NoticeModel.prototype.noticeCount=function(){this.get(this.noticeCountUrl)};WE.api.NoticeModel.prototype.noticeList=function(){this.get(this.noticeListUrl)};WE.api.NoticeModel.prototype.noticeStatus=function(a){this.post(this.noticeStatusUrl,{_id:a})};WE.pageTop={setUserName:function(a){var c=new WE.Dialog({title:"\u4fee\u6539\u6635\u79f0",id:"setUserName",width:400,height:200});c.onclose=function(){console.log("What")};c.show();WE.kit.getTmpl("update_user_name.ejs",function(d){d=WE.kit.tmpl(d,a);c.append(d);$("#setUserNameForm").submit(function(){var a=$("#newUserName"),e=a.val();if(e){$("#setUserNameForm input[type=submit]").attr("disabled","disabled").val("\u63d0\u4ea4\u4e2d...");var a=new WE.api.ChatModel,d=new WE.Controller;d.update=function(a){a=
a.data;$("#setUserNameForm input[type=submit]").removeAttr("disabled").val("\u63d0\u4ea4");a.code==0?(c.close(),setTimeout(function(){document.location.reload()},500)):alert(a.msg)};a.addObserver(d);a.updateUserName(e)}else a.focus();return!1});$("#anonymous").click(function(){$("#newUserName").val("\u533f\u540d");$("#setUserNameForm").submit()})})},bindEmail:function(){function a(a,b){$("#bindMialForm input[type=submit]").attr("disabled","disabled").val("\u63d0\u4ea4\u4e2d...");var e=new WE.api.ChatModel,
g=new WE.Controller;g.update=function(a){a=a.data;$("#bindMialForm input[type=submit]").removeAttr("disabled").val("\u63d0\u4ea4");a.code==0?(c.close(),setTimeout(function(){document.location.reload()},600)):alert(a.msg)};e.addObserver(g);e.updateMailPwd(a,b)}var c=new WE.Dialog({title:"\u8bbe\u7f6email",id:"setMail",width:400,height:200});c.show();WE.kit.getTmpl("bind_mail.ejs",function(d){c.append(d);$("#bindMialForm").submit(function(){var b=$.trim($("#updateMail").val()),c=$.trim($("#updatePwd").val());
/^[\w._\-]+@[\w_\-]+\.\w+$/.test(b)?c.length>5?a(b,c):alert("\u5bc6\u7801\u957f\u5ea6\u81f3\u5c116\u4f4d"):alert("mail, \u683c\u5f0f\u4e0d\u6b63\u786e");return!1})})},getHistory:function(){var a=new WE.Dialog({title:"\u53c2\u4e0e\u8fc7\u7684\u5bf9\u8bdd",id:"getHistory",width:200,height:200});a.show();WE.kit.getTmpl("history_chat.ejs",function(c){var d=new WE.api.TopModel,b=new WE.Controller;b.update=function(b){b=b.data;b.code==0&&(b=WE.kit.tmpl(c,b.result),a.append(b))};d.addObserver(b);d.historyChats()})}};
WE.pageTop.notice={isShowContent:!1,noticeCount:0,init:function(){var a=$("#notice-box");this.ui={box:a,circle:a.find(".circle"),list:a.find(".notice-list"),title:a.find(".notice-title"),content:a.find(".notice-content"),loading:a.find(".we-loading"),allLink:a.find(".notic-all")};this.setNoticeCount();this.regEvent()},regEvent:function(){var a=this;a.ui.title.click(function(){a.isShowContent?(a.ui.content.hide(),a.isShowContent=!1):(a.isShowContent=!0,a.ui.content.show(),a.getNoticeList());return!1});
a.ui.list.delegate(".del","click",function(){var c=$(this).attr("data-mid");a.deleteOne(c);$(this).parent("li").animate({opacity:0},800,function(){$(this).remove();a.getNoticeList()});return!1});$(document.body).click(function(){a.isShowContent=!1;a.ui.content.hide()});a.ui.box.click(function(a){a.stopPropagation()})},noticeItemTmpl:'<li>\t\t\t\t\t\t<div class="notice-news">\t\t\t\t\t\t\t<a target="_blank" href="/user/<%=from._id%>"><%= from.name %></a> \u5728\t\t\t\t\t\t\t<a target="_blank" data-mid="<%= _id %>" class="notice-item" href="/d/<%= what %>?noticeid=<%= _id %>#<%= response %>"><%= where.topic %></a>\t\t\t\t\t\t\t\u56de\u590d\u4e86\u4f60\t\t\t\t\t\t</div>\t\t\t\t\t  \t<a data-mid="<%= _id %>" data-mid="<%= _id %>" class="muted pull-right del">\u4e0d\u518d\u63d0\u9192</a>\t\t\t\t\t  </li>',
noNoticeTmpl:'<p class="muted">\u6700\u8fd1\u6ca1\u6709\u6536\u5230\u65b0\u63d0\u9192...</p>',setNoticeCount:function(){var a=this,c=new WE.api.NoticeModel,d=new WE.Controller;d.update=function(b){b=b.data;if(b.code==0&&b.result>0)a.noticeCount=b.result,a.ui.circle.show()};c.addObserver(d);c.noticeCount()},getNoticeList:function(){var a=this,c=new WE.api.NoticeModel,d=new WE.Controller;d.update=function(b){b=b.data;if(b.code===0){var c=b.result.list,d='<ul class="reset" >';if(b.result.count>0){a.ui.allLink.text("\u67e5\u770b\u5168\u90e8\u63d0\u9192("+
b.result.count+")");for(var f=0;f<c.length;f++)d+=WE.kit.tmpl(a.noticeItemTmpl,c[f]);d+="</ul>";a.ui.loading.remove();a.ui.list.html(d)}else a.ui.allLink.text("\u67e5\u770b\u5168\u90e8\u63d0\u9192"),a.ui.list.html(a.noNoticeTmpl);b.result.count<6&&a.ui.circle.hide()}else a.ui.list.html("<p>"+b.msg+"</p>")};c.addObserver(d);c.noticeList()},deleteOne:function(a){(new WE.api.NoticeModel).noticeStatus(a)}};
WE.pageTop.init=function(){var a=this;$("#username").click(function(){a.setUserName(USER)});$("#bindmail").click(function(){a.bindEmail()});$("#chatme").click(function(){a.getHistory()});a.notice.init()};$(document).ready(function(){WE.pageTop.init()});
